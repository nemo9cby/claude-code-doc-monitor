<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>build-with-claude/batch-processing - Diff Report</title>
    <link rel="stylesheet" href="../../css/diff.css">
    <style>
        :root {
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --text-color: #eee;
            --accent: #0f3460;
            --add-bg: #1a4d1a;
            --del-bg: #4d1a1a;
            --add-text: #4ade80;
            --del-text: #f87171;
        }
        @media (prefers-color-scheme: light) {
            :root {
                --bg-color: #f5f5f5;
                --card-bg: #fff;
                --text-color: #333;
                --accent: #e0e0e0;
                --add-bg: #d4edda;
                --del-bg: #f8d7da;
                --add-text: #155724;
                --del-text: #721c24;
            }
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 2rem;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header { margin-bottom: 2rem; }
        h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .meta { color: #888; font-size: 0.9rem; }
        .summary {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: flex;
            gap: 2rem;
        }
        .stat { display: flex; align-items: center; gap: 0.5rem; }
        .stat.added { color: var(--add-text); }
        .stat.removed { color: var(--del-text); }
        .analysis {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border-left: 4px solid #8b5cf6;
        }
        .analysis-header {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #8b5cf6;
        }
        .analysis-content {
            white-space: pre-wrap;
            font-size: 0.95rem;
            line-height: 1.7;
        }
        .diff-container {
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
        }
        .diff-header {
            background: var(--accent);
            padding: 0.75rem 1rem;
            font-weight: 600;
        }
        .diff-content {
            padding: 1rem;
            overflow-x: auto;
        }
        .diff-content ins {
            background: var(--add-bg);
            color: var(--add-text);
            text-decoration: none;
            padding: 0.1em 0.2em;
            border-radius: 2px;
        }
        .diff-content del {
            background: var(--del-bg);
            color: var(--del-text);
            text-decoration: line-through;
            padding: 0.1em 0.2em;
            border-radius: 2px;
        }
        pre {
            background: var(--accent);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.85rem;
            margin-top: 2rem;
        }
        a { color: #60a5fa; }
        .back-link { margin-bottom: 1rem; display: inline-block; }
    </style>
</head>
<body>
    <div class="container">
        <a href="../../index.html" class="back-link">&larr; Back to daily report</a>

        <header>
            <h1>build-with-claude/batch-processing.md</h1>
            <p class="meta">Changed on 2026-02-25 10:57:41 EST</p>
        </header>

        <div class="summary">
            <div class="stat added">
                <span>+15</span> lines added
            </div>
            <div class="stat removed">
                <span>-27</span> lines removed
            </div>
        </div>

        

        <div class="diff-container">
            <div class="diff-header">Visual Diff</div>
            <div class="diff-content"><span># Batch processing&para;<br>&para;<br>---&para;<br>&para;<br>Batch processing is a powerful approach for handling large volumes of requests efficiently. Instead of processing requests one at a time with immediate responses, batch processing allows you to submit multiple requests together for asynchronous processing. This pattern is particularly useful when:&para;<br>&para;<br>- You need to process large volumes of data&para;<br>- Immediate responses are not required&para;<br>- You want to optimize for cost efficiency&para;<br>- You're running large-scale evaluations or analyses&para;<br>&para;<br>The Message Batches API is Anthropic's first implementation of this pattern.&para;<br>&para;<br>&lt;Note&gt;&para;<br>This feature is **not** covered by [Zero Data Retention (ZDR)](/docs/en/build-with-claude/zero-data-retention) arrangements. Data is retained according to the feature's standard retention policy.&para;<br>&lt;/Note&gt;&para;<br>&para;<br>---&para;<br>&para;<br># Message Batches API&para;<br>&para;<br>The Message Batches API is a powerful, cost-effective way to asynchronously process large volumes of [Messages](/docs/en/api/messages) requests. This approach is well-suited to tasks that do not require immediate responses, with most batches finishing in less than 1 hour while reducing costs by 50% and increasing throughput.&para;<br>&para;<br>You can [explore the API reference directly](/docs/en/api/creating-message-batches), in addition to this guide.&para;<br>&para;<br>## How the Message Batches API works&para;<br>&para;<br>When you send a request to the Message Batches API:&para;<br>&para;<br>1. The system creates a new Message Batch with the provided Messages requests.&para;<br>2. The batch is then processed asynchronously, with each request handled independently.&para;<br>3. You can poll for the status of the batch and retrieve results when processing has ended for all requests.&para;<br>&para;<br>This is especially useful for bulk operations that don't require immediate results, such as:&para;<br>- Large-scale evaluations: Process thousands of test cases efficiently.&para;<br>- Content moderation: Analyze large volumes of user-generated content asynchronously.&para;<br>- Data analysis: Generate insights or summaries for large datasets.&para;<br>- Bulk content generation: Create large amounts of text for various purposes (e.g., product descriptions, article summaries).&para;<br>&para;<br>### Batch limitations&para;<br>- A Message Batch is limited to either 100,000 Message requests or 256 MB in size, whichever is reached first.&para;<br>- The system processes each batch as fast as possible, with most batches completing within 1 hour. You will be able to access batch results when all messages have completed or after 24 hours, whichever comes first. Batches will expire if processing does not complete within 24 hours.&para;<br>- Batch results are available for 29 days after creation. After that, you may still view the Batch, but its results will no longer be available for download.&para;<br>- Batches are scoped to a [Workspace](/settings/workspaces). You may view all batches (and their results) that were created within the Workspace that your API key belongs to.&para;<br>- Rate limits apply to both Batches API HTTP requests and the number of requests within a batch waiting to be processed. See [Message Batches API rate limits](/docs/en/api/rate-limits#message-batches-api). Additionally, processing may be slowed down based on current demand and your request volume. In that case, you may see more requests expiring after 24 hours.&para;<br>- Due to high throughput and concurrent processing, batches may go slightly over your Workspace's configured [spend limit](/settings/limits).&para;<br>&para;<br>### Supported models&para;<br>&para;<br>All [active models](/docs/en/about-claude/models/overview) support the Message Batches API.&para;<br>&para;<br>### What can be batched&para;<br>Any request that you can make to the Messages API can be included in a batch. This includes:&para;<br>&para;<br>- Vision&para;<br>- Tool use&para;<br>- System messages&para;<br>- Multi-turn conversations&para;<br>- Any beta features&para;<br>&para;<br>Since each request in the batch is processed independently, you can mix different types of requests within a single batch.&para;<br>&para;<br>&lt;Tip&gt;&para;<br>Since batches can take longer than 5 minutes to process, consider using the [1-hour cache duration](/docs/en/build-with-claude/prompt-caching#1-hour-cache-duration) with prompt caching for better cache hit rates when processing batches with shared context.&para;<br>&lt;/Tip&gt;&para;<br>&para;<br>---&para;<br>## Pricing&para;<br>&para;<br>The Batches API offers significant cost savings. All usage is charged at 50% of the standard API prices.&para;<br>&para;<br>| Model             | Batch input      | Batch output    |&para;<br>|-------------------|------------------|-----------------|&para;<br>| Claude Opus 4.6       | $2.50 / MTok     | $12.50 / MTok   |&para;<br>| Claude Opus 4.5     | $2.50 / MTok     | $12.50 / MTok   |&para;<br>| Claude Opus 4.1     | $7.50 / MTok     | $37.50 / MTok   |&para;<br>| Claude Opus 4     | $7.50 / MTok     | $37.50 / MTok   |&para;<br>| Claude Sonnet 4.6   | $1.50 / MTok     | $7.50 / MTok    |&para;<br>| Claude Sonnet 4.5   | $1.50 / MTok     | $7.50 / MTok    |&para;<br>| Claude Sonnet 4   | $1.50 / MTok     | $7.50 / MTok    |&para;<br>| Claude Sonnet 3.7 ([deprecated](/docs/en/about-claude/model-deprecations)) | $1.50 / MTok     | $7.50 / MTok    |&para;<br>| Claude Haiku 4.5  | $0.50 / MTok     | $2.50 / MTok    |&para;<br>| Claude Haiku 3.5  | $0.40 / MTok     | $2 / MTok       |&para;<br>| Claude Opus 3 ([deprecated](/docs/en/about-claude/model-deprecations))  | $7.50 / MTok     | $37.50 / MTok   |&para;<br>| Claude Haiku 3    | $0.125 / MTok    | $0.625 / MTok   |&para;<br>&para;<br>---&para;<br>## How to use the Message Batches API&para;<br>&para;<br>### Prepare and create your batch&para;<br>&para;<br>A Message Batch is composed of a list of requests to create a Message. The shape of an individual request is comprised of:&para;<br>- A unique `custom_id` for identifying the Messages request&para;<br>- A `params` object with the standard [Messages API](/docs/en/api/messages) parameters&para;<br>&para;<br>You can [create a batch](/docs/en/api/creating-message-batches) by passing this list into the `requests` parameter:&para;<br>&para;<br>&lt;CodeGroup&gt;&para;<br>&para;<br>```bash Shell&para;<br>curl https://api.anthropic.com/v1/messages/batches \&para;<br>     --header "x-api-key: $ANTHROPIC_API_KEY" \&para;<br>     --header "anthropic-version: 2023-06-01" \&para;<br>     --header "content-type: application/json" \&para;<br>     --data \&para;<br>'{&para;<br>    "requests": [&para;<br>        {&para;<br>            "custom_id": "my-first-request",&para;<br>            "params": {&para;<br>                "model": "claude-opus-4-6",&para;<br>                "max_tokens": 1024,&para;<br>                "messages": [&para;<br>                    {"role": "user", "content": "Hello, world"}&para;<br>                ]&para;<br>            }&para;<br>        },&para;<br>        {&para;<br>            "custom_id": "my-second-request",&para;<br>            "params": {&para;<br>                "model": "claude-opus-4-6",&para;<br>                "max_tokens": 1024,&para;<br>                "messages": [&para;<br>                    {"role": "user", "content": "Hi again, friend"}&para;<br>                ]&para;<br>            }&para;<br>        }&para;<br>    ]&para;<br>}'&para;<br>```&para;<br>&para;<br>```python Python&para;<br>import anthropic&para;<br>from anthropic.types.message_create_params import MessageCreateParamsNonStreaming&para;<br>from anthropic.types.messages.batch_create_params import Request&para;<br>&para;<br>client = anthropic.Anthropic()&para;<br>&para;<br>message_batch = client.messages.batches.create(&para;<br>    requests=[&para;<br>        Request(&para;<br>            custom_id="my-first-request",&para;<br>            params=MessageCreateParamsNonStreaming(&para;<br>                model="claude-opus-4-6",&para;<br>                max_tokens=1024,&para;<br>                messages=[&para;<br>                    {&para;<br>                        "role": "user",&para;<br>                        "content": "Hello, world",&para;<br>                    }&para;<br>                ],&para;<br>            ),&para;<br>        ),&para;<br>        Request(&para;<br>            custom_id="my-second-request",&para;<br>            params=MessageCreateParamsNonStreaming(&para;<br>                model="claude-opus-4-6",&para;<br>                max_tokens=1024,&para;<br>                messages=[&para;<br>                    {&para;<br>                        "role": "user",&para;<br>                        "content": "Hi again, friend",&para;<br>                    }&para;<br>                ],&para;<br>            ),&para;<br>        ),&para;<br>    ]&para;<br>)&para;<br>&para;<br>print(message_batch)&para;<br>```&para;<br>&para;<br>```typescript TypeScript&para;<br>import Anthropic from "@anthropic-ai/sdk";&para;<br>&para;<br>const anthropic = new Anthropic();&para;<br>&para;<br>const messageBatch = await anthropic.messages.batches.create({&para;<br>  requests: [</span><del style="background:#ffe6e6;">{</del><span>&para;<br></span><ins style="background:#e6ffe6;">    {&para;<br>  </ins><span>    custom_id: "my-first-request",&para;<br>    </span><ins style="background:#e6ffe6;">  </ins><span>params: {&para;<br></span><ins style="background:#e6ffe6;">  </ins><span>      model: "claude-opus-4-6",&para;<br>      </span><ins style="background:#e6ffe6;">  </ins><span>max_tokens: 1024,&para;<br>      </span><ins style="background:#e6ffe6;"> </ins><ins style="background:#e6ffe6;"> </ins><span>messages: [</span><del style="background:#ffe6e6;">&para;<br>        </del><span>{ role: "user", content: "Hello, world" }</span><ins style="background:#e6ffe6;">]</ins><span>&para;<br>      </span><del style="background:#ffe6e6;">]</del><ins style="background:#e6ffe6;">}</ins><span>&para;<br>    }</span><ins style="background:#e6ffe6;">,</ins><span>&para;<br>  </span><del style="background:#ffe6e6;">},</del><ins style="background:#e6ffe6;"> </ins><span> {&para;<br></span><ins style="background:#e6ffe6;">  </ins><span>    custom_id: "my-second-request",&para;<br>    </span><ins style="background:#e6ffe6;"> </ins><ins style="background:#e6ffe6;"> </ins><span>params: {&para;<br></span><ins style="background:#e6ffe6;">  </ins><span>      model: "claude-opus-4-6",&para;<br>      </span><ins style="background:#e6ffe6;">  </ins><span>max_tokens: 1024,&para;<br>      </span><ins style="background:#e6ffe6;"> </ins><ins style="background:#e6ffe6;"> </ins><span>messages: [</span><del style="background:#ffe6e6;">&para;<br>        </del><span>{ role: "user", content: "Hi again, friend" }</span><ins style="background:#e6ffe6;">]</ins><span>&para;<br>      </span><del style="background:#ffe6e6;">]</del><ins style="background:#e6ffe6;">}</ins><span>&para;<br>    }&para;<br>  </span><del style="background:#ffe6e6;">}</del><span>]&para;<br>});&para;<br>&para;<br>console.log(messageBatch);&para;<br>```&para;<br>&para;<br>```java Java&para;<br>import com.anthropic.client.AnthropicClient;&para;<br>import com.anthropic.client.okhttp.AnthropicOkHttpClient;&para;<br>import com.anthropic.models.messages.Model;&para;<br>import com.anthropic.models.messages.batches.*;&para;<br>&para;<br>public class BatchExample {&para;<br>&para;<br>  public static void main(String[] args) {&para;<br>    AnthropicClient client = AnthropicOkHttpClient.fromEnv();&para;<br>&para;<br>    BatchCreateParams params = BatchCreateParams.builder()&para;<br>      .addRequest(&para;<br>        BatchCreateParams.Request.builder()&para;<br>          .customId("my-first-request")&para;<br>          .params(&para;<br>            BatchCreateParams.Request.Params.builder()&para;<br>              .model(Model.CLAUDE_OPUS_4_6)&para;<br>              .maxTokens(1024)&para;<br>              .addUserMessage("Hello, world")&para;<br>              .build()&para;<br>          )&para;<br>          .build()&para;<br>      )&para;<br>      .addRequest(&para;<br>        BatchCreateParams.Request.builder()&para;<br>          .customId("my-second-request")&para;<br>          .params(&para;<br>            BatchCreateParams.Request.Params.builder()&para;<br>              .model(Model.CLAUDE_OPUS_4_6)&para;<br>              .maxTokens(1024)&para;<br>              .addUserMessage("Hi again, friend")&para;<br>              .build()&para;<br>          )&para;<br>          .build()&para;<br>      )&para;<br>      .build();&para;<br>&para;<br>    MessageBatch messageBatch = client.messages().batches().create(params);&para;<br>&para;<br>    System.out.println(messageBatch);&para;<br>  }&para;<br>}&para;<br>```&para;<br>&para;<br>```go Go&para;<br>package main&para;<br>&para;<br>import (&para;<br>	"context"&para;<br>	"fmt"&para;<br>&para;<br>	"github.com/anthropics/anthropic-sdk-go"&para;<br>)&para;<br>&para;<br>func main() {&para;<br>	client := anthropic.NewClient()&para;<br>&para;<br>	batch, _ := client.Messages.Batches.New(context.Background(),&para;<br>		anthropic.BatchCreateParams{&para;<br>			Requests: []anthropic.BatchCreateParamsRequest{&para;<br>				{&para;<br>					CustomID: "my-first-request",&para;<br>					Params: anthropic.BatchCreateParamsRequestParams{&para;<br>						Model:     anthropic.ModelClaudeOpus4_6,&para;<br>						MaxTokens: 1024,&para;<br>						Messages: []anthropic.MessageParam{&para;<br>							anthropic.NewUserMessage(&para;<br>								anthropic.NewTextBlock("Hello, world"),&para;<br>							),&para;<br>						},&para;<br>					},&para;<br>				},&para;<br>				{&para;<br>					CustomID: "my-second-request",&para;<br>					Params: anthropic.BatchCreateParamsRequestParams{&para;<br>						Model:     anthropic.ModelClaudeOpus4_6,&para;<br>						MaxTokens: 1024,&para;<br>						Messages: []anthropic.MessageParam{&para;<br>							anthropic.NewUserMessage(&para;<br>								anthropic.NewTextBlock("Hi again, friend"),&para;<br>							),&para;<br>						},&para;<br>					},&para;<br>				},&para;<br>			},&para;<br>		})&para;<br>&para;<br>	fmt.Println(batch.ID)&para;<br>}&para;<br>```&para;<br>&para;<br>```ruby Ruby&para;<br>require "anthropic"&para;<br>&para;<br>client = Anthropic::Client.new&para;<br>&para;<br>batch = client.messages.batches.create(&para;<br>  requests: [&para;<br>    {&para;<br>      custom_id: "my-first-request",&para;<br>      params: {&para;<br>        model: "claude-opus-4-6",&para;<br>        max_tokens: 1024,&para;<br>        messages: [&para;<br>          { role: "user", content: "Hello, world" }&para;<br>        ]&para;<br>      }&para;<br>    },&para;<br>    {&para;<br>      custom_id: "my-second-request",&para;<br>      params: {&para;<br>        model: "claude-opus-4-6",&para;<br>        max_tokens: 1024,&para;<br>        messages: [&para;<br>          { role: "user", content: "Hi again, friend" }&para;<br>        ]&para;<br>      }&para;<br>    }&para;<br>  ]&para;<br>)&para;<br>&para;<br>puts batch&para;<br>```&para;<br>&para;<br>```csharp C#&para;<br>using Anthropic;&para;<br>&para;<br>var client = new AnthropicClient();&para;<br>&para;<br>var batch = await client.Messages.Batches.CreateAsync(&para;<br>    new BatchCreateParams&para;<br>    {&para;<br>        Requests = new[]&para;<br>        {&para;<br>            new BatchCreateParams.Request&para;<br>            {&para;<br>                CustomId = "my-first-request",&para;<br>                Params = new BatchCreateParams.Request.Params&para;<br>                {&para;<br>                    Model = "claude-opus-4-6",&para;<br>                    MaxTokens = 1024,&para;<br>                    Messages = new[]&para;<br>                    {&para;<br>                        new MessageParam { Role = "user", Content = "Hello, world" }&para;<br>                    }&para;<br>                }&para;<br>            },&para;<br>            new BatchCreateParams.Request&para;<br>            {&para;<br>                CustomId = "my-second-request",&para;<br>                Params = new BatchCreateParams.Request.Params&para;<br>                {&para;<br>                    Model = "claude-opus-4-6",&para;<br>                    MaxTokens = 1024,&para;<br>                    Messages = new[]&para;<br>                    {&para;<br>                        new MessageParam { Role = "user", Content = "Hi again, friend" }&para;<br>                    }&para;<br>                }&para;<br>            }&para;<br>        }&para;<br>    });&para;<br>&para;<br>Console.WriteLine(batch);&para;<br>```&para;<br>&para;<br>```php PHP&para;<br>&lt;?php&para;<br>&para;<br>use Anthropic\Client;&para;<br>&para;<br>$client = new Client(&para;<br>    apiKey: getenv("ANTHROPIC_API_KEY")&para;<br>);&para;<br>&para;<br>$batch = $client-&gt;messages-&gt;batches-&gt;create([&para;<br>    'requests' =&gt; [&para;<br>        [&para;<br>            'custom_id' =&gt; 'my-first-request',&para;<br>            'params' =&gt; [&para;<br>                'model' =&gt; 'claude-opus-4-6',&para;<br>                'max_tokens' =&gt; 1024,&para;<br>                'messages' =&gt; [&para;<br>                    ['role' =&gt; 'user', 'content' =&gt; 'Hello, world']&para;<br>                ]&para;<br>            ]&para;<br>        ],&para;<br>        [&para;<br>            'custom_id' =&gt; 'my-second-request',&para;<br>            'params' =&gt; [&para;<br>                'model' =&gt; 'claude-opus-4-6',&para;<br>                'max_tokens' =&gt; 1024,&para;<br>                'messages' =&gt; [&para;<br>                    ['role' =&gt; 'user', 'content' =&gt; 'Hi again, friend']&para;<br>                ]&para;<br>            ]&para;<br>        ]&para;<br>    ]&para;<br>]);&para;<br>&para;<br>print_r($batch);&para;<br>```&para;<br>&para;<br>&lt;/CodeGroup&gt;&para;<br>&para;<br>In this example, two separate requests are batched together for asynchronous processing. Each request has a unique `custom_id` and contains the standard parameters you'd use for a Messages API call.&para;<br>&para;<br>&lt;Tip&gt;&para;<br>  **Test your batch requests with the Messages API**&para;<br>&para;<br>Validation of the `params` object for each message request is performed asynchronously, and validation errors are returned when processing of the entire batch has ended. You can ensure that you are building your input correctly by verifying your request shape with the [Messages API](/docs/en/api/messages) first.&para;<br>&lt;/Tip&gt;&para;<br>&para;<br>When a batch is first created, the response will have a processing status of `in_progress`.&para;<br>&para;<br>```json JSON&para;<br>{&para;<br>  "id": "msgbatch_01HkcTjaV5uDC8jWR4ZsDV8d",&para;<br>  "type": "message_batch",&para;<br>  "processing_status": "in_progress",&para;<br>  "request_counts": {&para;<br>    "processing": 2,&para;<br>    "succeeded": 0,&para;<br>    "errored": 0,&para;<br>    "canceled": 0,&para;<br>    "expired": 0&para;<br>  },&para;<br>  "ended_at": null,&para;<br>  "created_at": "2024-09-24T18:37:24.100435Z",&para;<br>  "expires_at": "2024-09-25T18:37:24.100435Z",&para;<br>  "cancel_initiated_at": null,&para;<br>  "results_url": null&para;<br>}&para;<br>```&para;<br>&para;<br>### Tracking your batch&para;<br>&para;<br>The Message Batch's `processing_status` field indicates the stage of processing the batch is in. It starts as `in_progress`, then updates to `ended` once all the requests in the batch have finished processing, and results are ready. You can monitor the state of your batch by visiting the [Console](/settings/workspaces/default/batches), or using the [retrieval endpoint](/docs/en/api/retrieving-message-batches).&para;<br>&para;<br>#### Polling for Message Batch completion&para;<br>&para;<br>To poll a Message Batch, you'll need its `id`, which is provided in the response when creating a batch or by listing batches. You can implement a polling loop that checks the batch status periodically until processing has ended:&para;<br>&para;<br>&lt;CodeGroup&gt;&para;<br>```python Python&para;<br>import anthropic&para;<br>import time&para;<br>&para;<br>client = anthropic.Anthropic()&para;<br>&para;<br>message_batch = None&para;<br>while True:&para;<br>    message_batch = client.messages.batches.retrieve(MESSAGE_BATCH_ID)&para;<br>    if message_batch.processing_status == "ended":&para;<br>        break&para;<br>&para;<br>    print(f"Batch {MESSAGE_BATCH_ID} is still processing...")&para;<br>    time.sleep(60)&para;<br>print(message_batch)&para;<br>```&para;<br>&para;<br>```typescript TypeScript&para;<br>import Anthropic from "@anthropic-ai/sdk";&para;<br>&para;<br>const anthropic = new Anthropic();&para;<br>&para;<br>let messageBatch;&para;<br>while (true) {&para;<br>  messageBatch = await anthropic.messages.batches.retrieve(</span><del style="background:#ffe6e6;">&para;<br>    </del><span>MESSAGE_BATCH_ID</span><del style="background:#ffe6e6;">&para;<br>  </del><span>);&para;<br>  if (messageBatch.processing_status === "ended") {&para;<br>    break;&para;<br>  }&para;<br>&para;<br>  console.log(`Batch ${messageBatch} is still processing... waiting`);&para;<br>  await new Promise(</span><ins style="background:#e6ffe6;">(</ins><span>resolve</span><ins style="background:#e6ffe6;">)</ins><span> =&gt; setTimeout(resolve, 60_000));&para;<br>}&para;<br>console.log(messageBatch);&para;<br>```&para;<br>&para;<br>```bash Shell&para;<br>#!/bin/sh&para;<br>&para;<br>until [[ $(curl -s "https://api.anthropic.com/v1/messages/batches/$MESSAGE_BATCH_ID" \&para;<br>          --header "x-api-key: $ANTHROPIC_API_KEY" \&para;<br>          --header "anthropic-version: 2023-06-01" \&para;<br>          | grep -o '"processing_status":[[:space:]]*"[^"]*"' \&para;<br>          | cut -d'"' -f4) == "ended" ]]; do&para;<br>    echo "Batch $MESSAGE_BATCH_ID is still processing..."&para;<br>    sleep 60&para;<br>done&para;<br>&para;<br>echo "Batch $MESSAGE_BATCH_ID has finished processing"&para;<br>```&para;<br>&lt;/CodeGroup&gt;&para;<br>&para;<br>### Listing all Message Batches&para;<br>&para;<br>You can list all Message Batches in your Workspace using the [list endpoint](/docs/en/api/listing-message-batches). The API supports pagination, automatically fetching additional pages as needed:&para;<br>&para;<br>&lt;CodeGroup&gt;&para;<br>```python Python&para;<br>import anthropic&para;<br>&para;<br>client = anthropic.Anthropic()&para;<br>&para;<br># Automatically fetches more pages as needed.&para;<br>for message_batch in client.messages.batches.list(limit=20):&para;<br>    print(message_batch)&para;<br>```&para;<br>&para;<br>```typescript TypeScript&para;<br>import Anthropic from "@anthropic-ai/sdk";&para;<br>&para;<br>const anthropic = new Anthropic();&para;<br>&para;<br>// Automatically fetches more pages as needed.&para;<br>for await (const messageBatch of anthropic.messages.batches.list({&para;<br>  limit: 20&para;<br>})) {&para;<br>  console.log(messageBatch);&para;<br>}&para;<br>```&para;<br>&para;<br>```bash Shell&para;<br>#!/bin/sh&para;<br>&para;<br>if ! command -v jq &amp;&gt; /dev/null; then&para;<br>    echo "Error: This script requires jq. Please install it first."&para;<br>    exit 1&para;<br>fi&para;<br>&para;<br>BASE_URL="https://api.anthropic.com/v1/messages/batches"&para;<br>&para;<br>has_more=true&para;<br>after_id=""&para;<br>&para;<br>while [ "$has_more" = true ]; do&para;<br>    # Construct URL with after_id if it exists&para;<br>    if [ -n "$after_id" ]; then&para;<br>        url="${BASE_URL}?limit=20&amp;after_id=${after_id}"&para;<br>    else&para;<br>        url="$BASE_URL?limit=20"&para;<br>    fi&para;<br>&para;<br>    response=$(curl -s "$url" \&para;<br>              --header "x-api-key: $ANTHROPIC_API_KEY" \&para;<br>              --header "anthropic-version: 2023-06-01")&para;<br>&para;<br>    # Extract values using jq&para;<br>    has_more=$(echo "$response" | jq -r '.has_more')&para;<br>    after_id=$(echo "$response" | jq -r '.last_id')&para;<br>&para;<br>    # Process and print each entry in the data array&para;<br>    echo "$response" | jq -c '.data[]' | while read -r entry; do&para;<br>        echo "$entry" | jq '.'&para;<br>    done&para;<br>done&para;<br>```&para;<br>&para;<br>```java Java&para;<br>import com.anthropic.client.AnthropicClient;&para;<br>import com.anthropic.client.okhttp.AnthropicOkHttpClient;&para;<br>import com.anthropic.models.messages.batches.*;&para;<br>&para;<br>public class BatchListExample {&para;<br>&para;<br>  public static void main(String[] args) {&para;<br>    AnthropicClient client = AnthropicOkHttpClient.fromEnv();&para;<br>&para;<br>    // Automatically fetches more pages as needed&para;<br>    for (MessageBatch messageBatch : client&para;<br>      .messages()&para;<br>      .batches()&para;<br>      .list(BatchListParams.builder().limit(20).build())) {&para;<br>      System.out.println(messageBatch);&para;<br>    }&para;<br>  }&para;<br>}&para;<br>```&para;<br>&lt;/CodeGroup&gt;&para;<br>&para;<br>### Retrieving batch results&para;<br>&para;<br>Once batch processing has ended, each Messages request in the batch will have a result. There are 4 result types:&para;<br>&para;<br>| Result Type | Description |&para;<br>|-------------|-------------|&para;<br>| `succeeded` | Request was successful. Includes the message result. |&para;<br>| `errored`   | Request encountered an error and a message was not created. Possible errors include invalid requests and internal server errors. You will not be billed for these requests. |&para;<br>| `canceled`  | User canceled the batch before this request could be sent to the model. You will not be billed for these requests. |&para;<br>| `expired`   | Batch reached its 24 hour expiration before this request could be sent to the model. You will not be billed for these requests. |&para;<br>&para;<br>You will see an overview of your results with the batch's `request_counts`, which shows how many requests reached each of these four states.&para;<br>&para;<br>Results of the batch are available for download at the `results_url` property on the Message Batch, and if the organization permission allows, in the Console. Because of the potentially large size of the results, it's recommended to [stream results](/docs/en/api/retrieving-message-batch-results) back rather than download them all at once.&para;<br>&para;<br>&lt;CodeGroup&gt;&para;<br>&para;<br>```bash Shell&para;<br>#!/bin/sh&para;<br>curl "https://api.anthropic.com/v1/messages/batches/msgbatch_01HkcTjaV5uDC8jWR4ZsDV8d" \&para;<br>  --header "anthropic-version: 2023-06-01" \&para;<br>  --header "x-api-key: $ANTHROPIC_API_KEY" \&para;<br>  | grep -o '"results_url":[[:space:]]*"[^"]*"' \&para;<br>  | cut -d'"' -f4 \&para;<br>  | while read -r url; do&para;<br>    curl -s "$url" \&para;<br>      --header "anthropic-version: 2023-06-01" \&para;<br>      --header "x-api-key: $ANTHROPIC_API_KEY" \&para;<br>      | sed 's/}{/}\n{/g' \&para;<br>      | while IFS= read -r line&para;<br>    do&para;<br>      result_type=$(echo "$line" | sed -n 's/.*"result":[[:space:]]*{[[:space:]]*"type":[[:space:]]*"\([^"]*\)".*/\1/p')&para;<br>      custom_id=$(echo "$line" | sed -n 's/.*"custom_id":[[:space:]]*"\([^"]*\)".*/\1/p')&para;<br>      error_type=$(echo "$line" | sed -n 's/.*"error":[[:space:]]*{[[:space:]]*"type":[[:space:]]*"\([^"]*\)".*/\1/p')&para;<br>&para;<br>      case "$result_type" in&para;<br>        "succeeded")&para;<br>          echo "Success! $custom_id"&para;<br>          ;;&para;<br>        "errored")&para;<br>          if [ "$error_type" = "invalid_request" ]; then&para;<br>            # Request body must be fixed before re-sending request&para;<br>            echo "Validation error: $custom_id"&para;<br>          else&para;<br>            # Request can be retried directly&para;<br>            echo "Server error: $custom_id"&para;<br>          fi&para;<br>          ;;&para;<br>        "expired")&para;<br>          echo "Expired: $line"&para;<br>          ;;&para;<br>      esac&para;<br>    done&para;<br>  done&para;<br>&para;<br>```&para;<br>```python Python&para;<br>import anthropic&para;<br>&para;<br>client = anthropic.Anthropic()&para;<br>&para;<br># Stream results file in memory-efficient chunks, processing one at a time&para;<br>for result in client.messages.batches.results(&para;<br>    "msgbatch_01HkcTjaV5uDC8jWR4ZsDV8d",&para;<br>):&para;<br>    match result.result.type:&para;<br>        case "succeeded":&para;<br>            print(f"Success! {result.custom_id}")&para;<br>        case "errored":&para;<br>            if result.result.error.type == "invalid_request":&para;<br>                # Request body must be fixed before re-sending request&para;<br>                print(f"Validation error {result.custom_id}")&para;<br>            else:&para;<br>                # Request can be retried directly&para;<br>                print(f"Server error {result.custom_id}")&para;<br>        case "expired":&para;<br>            print(f"Request expired {result.custom_id}")&para;<br>```&para;<br>&para;<br>```typescript TypeScript&para;<br>import Anthropic from "@anthropic-ai/sdk";&para;<br>&para;<br>const anthropic = new Anthropic();&para;<br>&para;<br>// Stream results file in memory-efficient chunks, processing one at a time&para;<br>for await (const result of await anthropic.messages.batches.results(&para;<br>  "msgbatch_01HkcTjaV5uDC8jWR4ZsDV8d"&para;<br>)) {&para;<br>  switch (result.result.type) {&para;<br>    case "succeeded":&para;<br>      console.log(`Success! ${result.custom_id}`);&para;<br>      break;&para;<br>    case "errored":&para;<br>      if (result.result.error.type == "invalid_request") {&para;<br>        // Request body must be fixed before re-sending request&para;<br>        console.log(`Validation error: ${result.custom_id}`);&para;<br>      } else {&para;<br>        // Request can be retried directly&para;<br>        console.log(`Server error: ${result.custom_id}`);&para;<br>      }&para;<br>      break;&para;<br>    case "expired":&para;<br>      console.log(`Request expired: ${result.custom_id}`);&para;<br>      break;&para;<br>  }&para;<br>}&para;<br>```&para;<br>&para;<br>```java Java&para;<br>import com.anthropic.client.AnthropicClient;&para;<br>import com.anthropic.client.okhttp.AnthropicOkHttpClient;&para;<br>import com.anthropic.core.http.StreamResponse;&para;<br>import com.anthropic.models.messages.batches.BatchResultsParams;&para;<br>import com.anthropic.models.messages.batches.MessageBatchIndividualResponse;&para;<br>&para;<br>public class BatchResultsExample {&para;<br>&para;<br>  public static void main(String[] args) {&para;<br>    AnthropicClient client = AnthropicOkHttpClient.fromEnv();&para;<br>&para;<br>    // Stream results file in memory-efficient chunks, processing one at a time&para;<br>    try (&para;<br>      StreamResponse&lt;MessageBatchIndividualResponse&gt; streamResponse = client&para;<br>        .messages()&para;<br>        .batches()&para;<br>        .resultsStreaming(&para;<br>          BatchResultsParams.builder()&para;<br>            .messageBatchId("msgbatch_01HkcTjaV5uDC8jWR4ZsDV8d")&para;<br>            .build()&para;<br>        )&para;<br>    ) {&para;<br>      streamResponse&para;<br>        .stream()&para;<br>        .forEach(result -&gt; {&para;<br>          if (result.result().isSucceeded()) {&para;<br>            System.out.println("Success! " + result.customId());&para;<br>          } else if (result.result().isErrored()) {&para;<br>            if (result.result().asErrored().error().error().isInvalidRequestError()) {&para;<br>              // Request body must be fixed before re-sending request&para;<br>              System.out.println("Validation error: " + result.customId());&para;<br>            } else {&para;<br>              // Request can be retried directly&para;<br>              System.out.println("Server error: " + result.customId());&para;<br>            }&para;<br>          } else if (result.result().isExpired()) {&para;<br>            System.out.println("Request expired: " + result.customId());&para;<br>          }&para;<br>        });&para;<br>    }&para;<br>  }&para;<br>}&para;<br>```&para;<br>&para;<br>&lt;/CodeGroup&gt;&para;<br>&para;<br>The results will be in `.jsonl` format, where each line is a valid JSON object representing the result of a single request in the Message Batch. For each streamed result, you can do something different depending on its `custom_id` and result type. Here is an example set of results:&para;<br>&para;<br>```json</span><ins style="background:#e6ffe6;">l</ins><span> .jsonl file&para;<br>{"custom_id":"my-second-request","result":{"type":"succeeded","message":{"id":"msg_014VwiXbi91y3JMjcpyGBHX5","type":"message","role":"assistant","model":"claude-opus-4-6","content":[{"type":"text","text":"Hello again! It's nice to see you. How can I assist you today? Is there anything specific you'd like to chat about or any questions you have?"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":11,"output_tokens":36}}}}&para;<br>{"custom_id":"my-first-request","result":{"type":"succeeded","message":{"id":"msg_01FqfsLoHwgeFbguDgpz48m7","type":"message","role":"assistant","model":"claude-opus-4-6","content":[{"type":"text","text":"Hello! How can I assist you today? Feel free to ask me any questions or let me know if there's anything you'd like to chat about."}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":10,"output_tokens":34}}}}&para;<br>```&para;<br>&para;<br>If your result has an error, its `result.error` will be set to the standard [error shape](/docs/en/api/errors#error-shapes).&para;<br>&para;<br>&lt;Tip&gt;&para;<br>  **Batch results may not match input order**&para;<br>&para;<br>Batch results can be returned in any order, and may not match the ordering of requests when the batch was created. In the above example, the result for the second batch request is returned before the first. To correctly match results with their corresponding requests, always use the `custom_id` field.&para;<br>&lt;/Tip&gt;&para;<br>&para;<br>### Canceling a Message Batch&para;<br>&para;<br>You can cancel a Message Batch that is currently processing using the [cancel endpoint](/docs/en/api/canceling-message-batches). Immediately after cancellation, a batch's `processing_status` will be `canceling`. You can use the same polling technique described above to wait until cancellation is finalized. Canceled batches end up with a status of `ended` and may contain partial results for requests that were processed before cancellation.&para;<br>&para;<br>&lt;CodeGroup&gt;&para;<br>```python Python&para;<br>import anthropic&para;<br>&para;<br>client = anthropic.Anthropic()&para;<br>&para;<br>message_batch = client.messages.batches.cancel(&para;<br>    MESSAGE_BATCH_ID,&para;<br>)&para;<br>print(message_batch)&para;<br>```&para;<br>&para;<br>```typescript TypeScript&para;<br>import Anthropic from "@anthropic-ai/sdk";&para;<br>&para;<br>const anthropic = new Anthropic();&para;<br>&para;<br>const messageBatch = await anthropic.messages.batches.cancel(</span><del style="background:#ffe6e6;">&para;<br>  </del><span>MESSAGE_BATCH_ID</span><del style="background:#ffe6e6;">&para;<br></del><span>);&para;<br>console.log(messageBatch);&para;<br>```&para;<br>&para;<br>```bash Shell&para;<br>#!/bin/sh&para;<br>curl --request POST https://api.anthropic.com/v1/messages/batches/$MESSAGE_BATCH_ID/cancel \&para;<br>    --header "x-api-key: $ANTHROPIC_API_KEY" \&para;<br>    --header "anthropic-version: 2023-06-01"&para;<br>```&para;<br>&para;<br>```java Java&para;<br>import com.anthropic.client.AnthropicClient;&para;<br>import com.anthropic.client.okhttp.AnthropicOkHttpClient;&para;<br>import com.anthropic.models.messages.batches.*;&para;<br>&para;<br>public class BatchCancelExample {&para;<br>&para;<br>  public static void main(String[] args) {&para;<br>    AnthropicClient client = AnthropicOkHttpClient.fromEnv();&para;<br>&para;<br>    MessageBatch messageBatch = client&para;<br>      .messages()&para;<br>      .batches()&para;<br>      .cancel(BatchCancelParams.builder().messageBatchId(MESSAGE_BATCH_ID).build());&para;<br>    System.out.println(messageBatch);&para;<br>  }&para;<br>}&para;<br>```&para;<br>&lt;/CodeGroup&gt;&para;<br>&para;<br>The response will show the batch in a `canceling` state:&para;<br>&para;<br>```json JSON&para;<br>{&para;<br>  "id": "msgbatch_013Zva2CMHLNnXjNJJKqJ2EF",&para;<br>  "type": "message_batch",&para;<br>  "processing_status": "canceling",&para;<br>  "request_counts": {&para;<br>    "processing": 2,&para;<br>    "succeeded": 0,&para;<br>    "errored": 0,&para;<br>    "canceled": 0,&para;<br>    "expired": 0&para;<br>  },&para;<br>  "ended_at": null,&para;<br>  "created_at": "2024-09-24T18:37:24.100435Z",&para;<br>  "expires_at": "2024-09-25T18:37:24.100435Z",&para;<br>  "cancel_initiated_at": "2024-09-24T18:39:03.114875Z",&para;<br>  "results_url": null&para;<br>}&para;<br>```&para;<br>&para;<br>### Using prompt caching with Message Batches&para;<br>&para;<br>The Message Batches API supports prompt caching, allowing you to potentially reduce costs and processing time for batch requests. The pricing discounts from prompt caching and Message Batches can stack, providing even greater cost savings when both features are used together. However, since batch requests are processed asynchronously and concurrently, cache hits are provided on a best-effort basis. Users typically experience cache hit rates ranging from 30% to 98%, depending on their traffic patterns.&para;<br>&para;<br>To maximize the likelihood of cache hits in your batch requests:&para;<br>&para;<br>1. Include identical `cache_control` blocks in every Message request within your batch&para;<br>2. Maintain a steady stream of requests to prevent cache entries from expiring after their 5-minute lifetime&para;<br>3. Structure your requests to share as much cached content as possible&para;<br>&para;<br>Example of implementing prompt caching in a batch:&para;<br>&para;<br>&lt;CodeGroup&gt;&para;<br>&para;<br>```bash Shell&para;<br>curl https://api.anthropic.com/v1/messages/batches \&para;<br>     --header "x-api-key: $ANTHROPIC_API_KEY" \&para;<br>     --header "anthropic-version: 2023-06-01" \&para;<br>     --header "content-type: application/json" \&para;<br>     --data \&para;<br>'{&para;<br>    "requests": [&para;<br>        {&para;<br>            "custom_id": "my-first-request",&para;<br>            "params": {&para;<br>                "model": "claude-opus-4-6",&para;<br>                "max_tokens": 1024,&para;<br>                "system": [&para;<br>                    {&para;<br>                        "type": "text",&para;<br>                        "text": "You are an AI assistant tasked with analyzing literary works. Your goal is to provide insightful commentary on themes, characters, and writing style.\n"&para;<br>                    },&para;<br>                    {&para;<br>                        "type": "text",&para;<br>                        "text": "&lt;the entire contents of Pride and Prejudice&gt;",&para;<br>                        "cache_control": {"type": "ephemeral"}&para;<br>                    }&para;<br>                ],&para;<br>                "messages": [&para;<br>                    {"role": "user", "content": "Analyze the major themes in Pride and Prejudice."}&para;<br>                ]&para;<br>            }&para;<br>        },&para;<br>        {&para;<br>            "custom_id": "my-second-request",&para;<br>            "params": {&para;<br>                "model": "claude-opus-4-6",&para;<br>                "max_tokens": 1024,&para;<br>                "system": [&para;<br>                    {&para;<br>                        "type": "text",&para;<br>                        "text": "You are an AI assistant tasked with analyzing literary works. Your goal is to provide insightful commentary on themes, characters, and writing style.\n"&para;<br>                    },&para;<br>                    {&para;<br>                        "type": "text",&para;<br>                        "text": "&lt;the entire contents of Pride and Prejudice&gt;",&para;<br>                        "cache_control": {"type": "ephemeral"}&para;<br>                    }&para;<br>                ],&para;<br>                "messages": [&para;<br>                    {"role": "user", "content": "Write a summary of Pride and Prejudice."}&para;<br>                ]&para;<br>            }&para;<br>        }&para;<br>    ]&para;<br>}'&para;<br>```&para;<br>&para;<br>```python Python&para;<br>import anthropic&para;<br>from anthropic.types.message_create_params import MessageCreateParamsNonStreaming&para;<br>from anthropic.types.messages.batch_create_params import Request&para;<br>&para;<br>client = anthropic.Anthropic()&para;<br>&para;<br>message_batch = client.messages.batches.create(&para;<br>    requests=[&para;<br>        Request(&para;<br>            custom_id="my-first-request",&para;<br>            params=MessageCreateParamsNonStreaming(&para;<br>                model="claude-opus-4-6",&para;<br>                max_tokens=1024,&para;<br>                system=[&para;<br>                    {&para;<br>                        "type": "text",&para;<br>                        "text": "You are an AI assistant tasked with analyzing literary works. Your goal is to provide insightful commentary on themes, characters, and writing style.\n",&para;<br>                    },&para;<br>                    {&para;<br>                        "type": "text",&para;<br>                        "text": "&lt;the entire contents of Pride and Prejudice&gt;",&para;<br>                        "cache_control": {"type": "ephemeral"},&para;<br>                    },&para;<br>                ],&para;<br>                messages=[&para;<br>                    {&para;<br>                        "role": "user",&para;<br>                        "content": "Analyze the major themes in Pride and Prejudice.",&para;<br>                    }&para;<br>                ],&para;<br>            ),&para;<br>        ),&para;<br>        Request(&para;<br>            custom_id="my-second-request",&para;<br>            params=MessageCreateParamsNonStreaming(&para;<br>                model="claude-opus-4-6",&para;<br>                max_tokens=1024,&para;<br>                system=[&para;<br>                    {&para;<br>                        "type": "text",&para;<br>                        "text": "You are an AI assistant tasked with analyzing literary works. Your goal is to provide insightful commentary on themes, characters, and writing style.\n",&para;<br>                    },&para;<br>                    {&para;<br>                        "type": "text",&para;<br>                        "text": "&lt;the entire contents of Pride and Prejudice&gt;",&para;<br>                        "cache_control": {"type": "ephemeral"},&para;<br>                    },&para;<br>                ],&para;<br>                messages=[&para;<br>                    {&para;<br>                        "role": "user",&para;<br>                        "content": "Write a summary of Pride and Prejudice.",&para;<br>                    }&para;<br>                ],&para;<br>            ),&para;<br>        ),&para;<br>    ]&para;<br>)&para;<br>```&para;<br>&para;<br>```typescript TypeScript&para;<br>import Anthropic from "@anthropic-ai/sdk";&para;<br>&para;<br>const anthropic = new Anthropic();&para;<br>&para;<br>const messageBatch = await anthropic.messages.batches.create({&para;<br>  requests: [</span><ins style="background:#e6ffe6;">&para;<br>    </ins><span>{&para;<br>    </span><ins style="background:#e6ffe6;"> </ins><ins style="background:#e6ffe6;"> </ins><span>custom_id: "my-first-request",&para;<br></span><ins style="background:#e6ffe6;">  </ins><span>    params: {&para;<br>      </span><ins style="background:#e6ffe6;">  </ins><span>model: "claude-opus-4-6",&para;<br>      </span><ins style="background:#e6ffe6;"> </ins><ins style="background:#e6ffe6;"> </ins><span>max_tokens: 1024,&para;<br>      </span><ins style="background:#e6ffe6;">  </ins><span>system: [&para;<br></span><ins style="background:#e6ffe6;">  </ins><span>        {&para;<br>          </span><ins style="background:#e6ffe6;">  </ins><span>type: "text",&para;<br></span><ins style="background:#e6ffe6;">  </ins><span>          text: "You are an AI assistant tasked with analyzing literary works. Your goal is to provide insightful commentary on themes, characters, and writing style.\n"&para;<br>        </span><ins style="background:#e6ffe6;">  </ins><span>},&para;<br>        </span><ins style="background:#e6ffe6;"> </ins><ins style="background:#e6ffe6;"> </ins><span>{&para;<br></span><ins style="background:#e6ffe6;">  </ins><span>          type: "text",&para;<br></span><ins style="background:#e6ffe6;">  </ins><span>          text: "&lt;the entire contents of Pride and Prejudice&gt;",&para;<br>          </span><ins style="background:#e6ffe6;"> </ins><ins style="background:#e6ffe6;"> </ins><span>cache_control: { type: "ephemeral" }&para;<br>        </span><del style="background:#ffe6e6;">}&para;<br></del><ins style="background:#e6ffe6;">  }&para;<br>  </ins><span>      ],&para;<br>      </span><ins style="background:#e6ffe6;"> </ins><ins style="background:#e6ffe6;"> </ins><span>messages: [&para;<br></span><ins style="background:#e6ffe6;">  </ins><span>        { role: "user", content: "Analyze the major themes in Pride and Prejudice." }&para;<br>      </span><del style="background:#ffe6e6;">]&para;<br></del><ins style="background:#e6ffe6;">  ]&para;<br>  </ins><span>    }&para;<br>  </span><del style="background:#ffe6e6;">},</del><ins style="background:#e6ffe6;">  },&para;<br>   </ins><span> {&para;<br></span><ins style="background:#e6ffe6;">  </ins><span>    custom_id: "my-second-request",&para;<br></span><ins style="background:#e6ffe6;">  </ins><span>    params: {&para;<br>      </span><ins style="background:#e6ffe6;">  </ins><span>model: "claude-opus-4-6",&para;<br>      </span><ins style="background:#e6ffe6;">  </ins><span>max_tokens: 1024,&para;<br></span><ins style="background:#e6ffe6;">  </ins><span>      system: [&para;<br>        </span><del style="background:#ffe6e6;">{&para;<br></del><ins style="background:#e6ffe6;">  {&para;<br>  </ins><span>          type: "text",&para;<br></span><ins style="background:#e6ffe6;">  </ins><span>          text: "You are an AI assistant tasked with analyzing literary works. Your goal is to provide insightful commentary on themes, characters, and writing style.\n"&para;<br>        </span><ins style="background:#e6ffe6;">  </ins><span>},&para;<br>        </span><ins style="background:#e6ffe6;">  </ins><span>{&para;<br>          </span><ins style="background:#e6ffe6;"> </ins><ins style="background:#e6ffe6;"> </ins><span>type: "text",&para;<br></span><ins style="background:#e6ffe6;">  </ins><span>          text: "&lt;the entire contents of Pride and Prejudice&gt;",&para;<br>          </span><ins style="background:#e6ffe6;">  </ins><span>cache_control: { type: "ephemeral" }&para;<br>        </span><ins style="background:#e6ffe6;"> </ins><ins style="background:#e6ffe6;"> </ins><span>}&para;<br></span><ins style="background:#e6ffe6;">  </ins><span>      ],&para;<br></span><ins style="background:#e6ffe6;">  </ins><span>      messages: [</span><del style="background:#ffe6e6;">&para;<br>        </del><span>{ role: "user", content: "Write a summary of Pride and Prejudice." }</span><ins style="background:#e6ffe6;">]</ins><span>&para;<br>      </span><del style="background:#ffe6e6;">]</del><ins style="background:#e6ffe6;">}</ins><span>&para;<br>    }&para;<br></span><span>  </span><del style="background:#ffe6e6;">}</del><span>]&para;<br>});&para;<br>```&para;<br>&para;<br>```java Java&para;<br>import com.anthropic.client.AnthropicClient;&para;<br>import com.anthropic.client.okhttp.AnthropicOkHttpClient;&para;<br>import com.anthropic.models.messages.CacheControlEphemeral;&para;<br>import com.anthropic.models.messages.Model;&para;<br>import com.anthropic.models.messages.TextBlockParam;&para;<br>import com.anthropic.models.messages.batches.*;&para;<br>import java.util.List;&para;<br>&para;<br>public class BatchExample {&para;<br>&para;<br>  public static void main(String[] args) {&para;<br>    AnthropicClient client = AnthropicOkHttpClient.fromEnv();&para;<br>&para;<br>    BatchCreateParams createParams = BatchCreateParams.builder()&para;<br>      .addRequest(&para;<br>        BatchCreateParams.Request.builder()&para;<br>          .customId("my-first-request")&para;<br>          .params(&para;<br>            BatchCreateParams.Request.Params.builder()&para;<br>              .model(Model.CLAUDE_OPUS_4_6)&para;<br>              .maxTokens(1024)&para;<br>              .systemOfTextBlockParams(&para;<br>                List.of(&para;<br>                  TextBlockParam.builder()&para;<br>                    .text(&para;<br>                      "You are an AI assistant tasked with analyzing literary works. Your goal is to provide insightful commentary on themes, characters, and writing style.\n"&para;<br>                    )&para;<br>                    .build(),&para;<br>                  TextBlockParam.builder()&para;<br>                    .text("&lt;the entire contents of Pride and Prejudice&gt;")&para;<br>                    .cacheControl(CacheControlEphemeral.builder().build())&para;<br>                    .build()&para;<br>                )&para;<br>              )&para;<br>              .addUserMessage("Analyze the major themes in Pride and Prejudice.")&para;<br>              .build()&para;<br>          )&para;<br>          .build()&para;<br>      )&para;<br>      .addRequest(&para;<br>        BatchCreateParams.Request.builder()&para;<br>          .customId("my-second-request")&para;<br>          .params(&para;<br>            BatchCreateParams.Request.Params.builder()&para;<br>              .model(Model.CLAUDE_OPUS_4_6)&para;<br>              .maxTokens(1024)&para;<br>              .systemOfTextBlockParams(&para;<br>                List.of(&para;<br>                  TextBlockParam.builder()&para;<br>                    .text(&para;<br>                      "You are an AI assistant tasked with analyzing literary works. Your goal is to provide insightful commentary on themes, characters, and writing style.\n"&para;<br>                    )&para;<br>                    .build(),&para;<br>                  TextBlockParam.builder()&para;<br>                    .text("&lt;the entire contents of Pride and Prejudice&gt;")&para;<br>                    .cacheControl(CacheControlEphemeral.builder().build())&para;<br>                    .build()&para;<br>                )&para;<br>              )&para;<br>              .addUserMessage("Write a summary of Pride and Prejudice.")&para;<br>              .build()&para;<br>          )&para;<br>          .build()&para;<br>      )&para;<br>      .build();&para;<br>&para;<br>    MessageBatch messageBatch = client.messages().batches().create(createParams);&para;<br>  }&para;<br>}&para;<br>```&para;<br>&para;<br>&lt;/CodeGroup&gt;&para;<br>&para;<br>In this example, both requests in the batch include identical system messages and the full text of Pride and Prejudice marked with `cache_control` to increase the likelihood of cache hits.&para;<br>&para;<br>### Best practices for effective batching&para;<br>&para;<br>To get the most out of the Batches API:&para;<br>&para;<br>- Monitor batch processing status regularly and implement appropriate retry logic for failed requests.&para;<br>- Use meaningful `custom_id` values to easily match results with requests, since order is not guaranteed.&para;<br>- Consider breaking very large datasets into multiple batches for better manageability.&para;<br>- Dry run a single request shape with the Messages API to avoid validation errors.&para;<br>&para;<br>### Troubleshooting common issues&para;<br>&para;<br>If experiencing unexpected behavior:&para;<br>&para;<br>- Verify that the total batch request size doesn't exceed 256 MB. If the request size is too large, you may get a 413 `request_too_large` error.&para;<br>- Check that you're using [supported models](#supported-models) for all requests in the batch.&para;<br>- Ensure each request in the batch has a unique `custom_id`.&para;<br>- Ensure that it has been less than 29 days since batch `created_at` (not processing `ended_at`) time. If over 29 days have passed, results will no longer be viewable.&para;<br>- Confirm that the batch has not been canceled.&para;<br>&para;<br>Note that the failure of one request in a batch does not affect the processing of other requests.&para;<br>&para;<br>---&para;<br>## Batch storage and privacy&para;<br>&para;<br>- **Workspace isolation**: Batches are isolated within the Workspace they are created in. They can only be accessed by API keys associated with that Workspace, or users with permission to view Workspace batches in the Console.&para;<br>&para;<br>- **Result availability**: Batch results are available for 29 days after the batch is created, allowing ample time for retrieval and processing.&para;<br>&para;<br>---&para;<br>## FAQ&para;<br>&para;<br>  &lt;section title="How long does it take for a batch to process?"&gt;&para;<br>&para;<br>    Batches may take up to 24 hours for processing, but many will finish sooner. Actual processing time depends on the size of the batch, current demand, and your request volume. It is possible for a batch to expire and not complete within 24 hours.&para;<br>  &para;<br>&lt;/section&gt;&para;<br>&para;<br>  &lt;section title="Is the Batches API available for all models?"&gt;&para;<br>&para;<br>    See [above](#supported-models) for the list of supported models.&para;<br>  &para;<br>&lt;/section&gt;&para;<br>&para;<br>  &lt;section title="Can I use the Message Batches API with other API features?"&gt;&para;<br>&para;<br>    Yes, the Message Batches API supports all features available in the Messages API, including beta features. However, streaming is not supported for batch requests.&para;<br>  &para;<br>&lt;/section&gt;&para;<br>&para;<br>  &lt;section title="How does the Message Batches API affect pricing?"&gt;&para;<br>&para;<br>    The Message Batches API offers a 50% discount on all usage compared to standard API prices. This applies to input tokens, output tokens, and any special tokens. For more on pricing, visit the [pricing page](https://claude.com/pricing#anthropic-api).&para;<br>  &para;<br>&lt;/section&gt;&para;<br>&para;<br>  &lt;section title="Can I update a batch after it's been submitted?"&gt;&para;<br>&para;<br>    No, once a batch has been submitted, it cannot be modified. If you need to make changes, you should cancel the current batch and submit a new one. Note that cancellation may not take immediate effect.&para;<br>  &para;<br>&lt;/section&gt;&para;<br>&para;<br>  &lt;section title="Are there Message Batches API rate limits and do they interact with the Messages API rate limits?"&gt;&para;<br>&para;<br>    The Message Batches API has HTTP requests-based rate limits in addition to limits on the number of requests in need of processing. See [Message Batches API rate limits](/docs/en/api/rate-limits#message-batches-api). Usage of the Batches API does not affect rate limits in the Messages API.&para;<br>  &para;<br>&lt;/section&gt;&para;<br>&para;<br>  &lt;section title="How do I handle errors in my batch requests?"&gt;&para;<br>&para;<br>    When you retrieve the results, each request will have a `result` field indicating whether it `succeeded`, `errored`, was `canceled`, or `expired`. For `errored` results, additional error information will be provided. View the error response object in the [API reference](/docs/en/api/creating-message-batches).&para;<br>  &para;<br>&lt;/section&gt;&para;<br>&para;<br>  &lt;section title="How does the Message Batches API handle privacy and data separation?"&gt;&para;<br>&para;<br>    The Message Batches API is designed with strong privacy and data separation measures:&para;<br>&para;<br>    1. Batches and their results are isolated within the Workspace in which they were created. This means they can only be accessed by API keys from that same Workspace.&para;<br>    2. Each request within a batch is processed independently, with no data leakage between requests.&para;<br>    3. Results are only available for a limited time (29 days), and follow Anthropic's [data retention policy](https://support.claude.com/en/articles/7996866-how-long-do-you-store-personal-data).&para;<br>    4. Downloading batch results in the Console can be disabled on the organization-level or on a per-workspace basis.&para;<br>  &para;<br>&lt;/section&gt;&para;<br>&para;<br>  &lt;section title="Can I use prompt caching in the Message Batches API?"&gt;&para;<br>&para;<br>    Yes, it is possible to use prompt caching with Message Batches API. However, because asynchronous batch requests can be processed concurrently and in any order, cache hits are provided on a best-effort basis.&para;<br>  &para;<br>&lt;/section&gt;</span></div>
        </div>

        <h2 style="margin-top: 2rem; margin-bottom: 1rem;">Unified Diff</h2>
        <pre><code>--- a/build-with-claude/batch-processing.md
+++ b/build-with-claude/batch-processing.md
@@ -176,25 +176,24 @@
 const anthropic = new Anthropic();
 
 const messageBatch = await anthropic.messages.batches.create({
-  requests: [{
-    custom_id: &#34;my-first-request&#34;,
-    params: {
-      model: &#34;claude-opus-4-6&#34;,
-      max_tokens: 1024,
-      messages: [
-        { role: &#34;user&#34;, content: &#34;Hello, world&#34; }
-      ]
+  requests: [
+    {
+      custom_id: &#34;my-first-request&#34;,
+      params: {
+        model: &#34;claude-opus-4-6&#34;,
+        max_tokens: 1024,
+        messages: [{ role: &#34;user&#34;, content: &#34;Hello, world&#34; }]
+      }
+    },
+    {
+      custom_id: &#34;my-second-request&#34;,
+      params: {
+        model: &#34;claude-opus-4-6&#34;,
+        max_tokens: 1024,
+        messages: [{ role: &#34;user&#34;, content: &#34;Hi again, friend&#34; }]
+      }
     }
-  }, {
-    custom_id: &#34;my-second-request&#34;,
-    params: {
-      model: &#34;claude-opus-4-6&#34;,
-      max_tokens: 1024,
-      messages: [
-        { role: &#34;user&#34;, content: &#34;Hi again, friend&#34; }
-      ]
-    }
-  }]
+  ]
 });
 
 console.log(messageBatch);
@@ -469,15 +468,13 @@
 
 let messageBatch;
 while (true) {
-  messageBatch = await anthropic.messages.batches.retrieve(
-    MESSAGE_BATCH_ID
-  );
+  messageBatch = await anthropic.messages.batches.retrieve(MESSAGE_BATCH_ID);
   if (messageBatch.processing_status === &#34;ended&#34;) {
     break;
   }
 
   console.log(`Batch ${messageBatch} is still processing... waiting`);
-  await new Promise(resolve =&gt; setTimeout(resolve, 60_000));
+  await new Promise((resolve) =&gt; setTimeout(resolve, 60_000));
 }
 console.log(messageBatch);
 ```
@@ -741,7 +738,7 @@
 
 The results will be in `.jsonl` format, where each line is a valid JSON object representing the result of a single request in the Message Batch. For each streamed result, you can do something different depending on its `custom_id` and result type. Here is an example set of results:
 
-```json .jsonl file
+```jsonl .jsonl file
 {&#34;custom_id&#34;:&#34;my-second-request&#34;,&#34;result&#34;:{&#34;type&#34;:&#34;succeeded&#34;,&#34;message&#34;:{&#34;id&#34;:&#34;msg_014VwiXbi91y3JMjcpyGBHX5&#34;,&#34;type&#34;:&#34;message&#34;,&#34;role&#34;:&#34;assistant&#34;,&#34;model&#34;:&#34;claude-opus-4-6&#34;,&#34;content&#34;:[{&#34;type&#34;:&#34;text&#34;,&#34;text&#34;:&#34;Hello again! It&#39;s nice to see you. How can I assist you today? Is there anything specific you&#39;d like to chat about or any questions you have?&#34;}],&#34;stop_reason&#34;:&#34;end_turn&#34;,&#34;stop_sequence&#34;:null,&#34;usage&#34;:{&#34;input_tokens&#34;:11,&#34;output_tokens&#34;:36}}}}
 {&#34;custom_id&#34;:&#34;my-first-request&#34;,&#34;result&#34;:{&#34;type&#34;:&#34;succeeded&#34;,&#34;message&#34;:{&#34;id&#34;:&#34;msg_01FqfsLoHwgeFbguDgpz48m7&#34;,&#34;type&#34;:&#34;message&#34;,&#34;role&#34;:&#34;assistant&#34;,&#34;model&#34;:&#34;claude-opus-4-6&#34;,&#34;content&#34;:[{&#34;type&#34;:&#34;text&#34;,&#34;text&#34;:&#34;Hello! How can I assist you today? Feel free to ask me any questions or let me know if there&#39;s anything you&#39;d like to chat about.&#34;}],&#34;stop_reason&#34;:&#34;end_turn&#34;,&#34;stop_sequence&#34;:null,&#34;usage&#34;:{&#34;input_tokens&#34;:10,&#34;output_tokens&#34;:34}}}}
 ```
@@ -775,9 +772,7 @@
 
 const anthropic = new Anthropic();
 
-const messageBatch = await anthropic.messages.batches.cancel(
-  MESSAGE_BATCH_ID
-);
+const messageBatch = await anthropic.messages.batches.cancel(MESSAGE_BATCH_ID);
 console.log(messageBatch);
 ```
 
@@ -965,47 +960,48 @@
 const anthropic = new Anthropic();
 
 const messageBatch = await anthropic.messages.batches.create({
-  requests: [{
-    custom_id: &#34;my-first-request&#34;,
-    params: {
-      model: &#34;claude-opus-4-6&#34;,
-      max_tokens: 1024,
-      system: [
-        {
-          type: &#34;text&#34;,
-          text: &#34;You are an AI assistant tasked with analyzing literary works. Your goal is to provide insightful commentary on themes, characters, and writing style.\n&#34;
-        },
-        {
-          type: &#34;text&#34;,
-          text: &#34;&lt;the entire contents of Pride and Prejudice&gt;&#34;,
-          cache_control: { type: &#34;ephemeral&#34; }
-        }
-      ],
-      messages: [
-        { role: &#34;user&#34;, content: &#34;Analyze the major themes in Pride and Prejudice.&#34; }
-      ]
+  requests: [
+    {
+      custom_id: &#34;my-first-request&#34;,
+      params: {
+        model: &#34;claude-opus-4-6&#34;,
+        max_tokens: 1024,
+        system: [
+          {
+            type: &#34;text&#34;,
+            text: &#34;You are an AI assistant tasked with analyzing literary works. Your goal is to provide insightful commentary on themes, characters, and writing style.\n&#34;
+          },
+          {
+            type: &#34;text&#34;,
+            text: &#34;&lt;the entire contents of Pride and Prejudice&gt;&#34;,
+            cache_control: { type: &#34;ephemeral&#34; }
+          }
+        ],
+        messages: [
+          { role: &#34;user&#34;, content: &#34;Analyze the major themes in Pride and Prejudice.&#34; }
+        ]
+      }
+    },
+    {
+      custom_id: &#34;my-second-request&#34;,
+      params: {
+        model: &#34;claude-opus-4-6&#34;,
+        max_tokens: 1024,
+        system: [
+          {
+            type: &#34;text&#34;,
+            text: &#34;You are an AI assistant tasked with analyzing literary works. Your goal is to provide insightful commentary on themes, characters, and writing style.\n&#34;
+          },
+          {
+            type: &#34;text&#34;,
+            text: &#34;&lt;the entire contents of Pride and Prejudice&gt;&#34;,
+            cache_control: { type: &#34;ephemeral&#34; }
+          }
+        ],
+        messages: [{ role: &#34;user&#34;, content: &#34;Write a summary of Pride and Prejudice.&#34; }]
+      }
     }
-  }, {
-    custom_id: &#34;my-second-request&#34;,
-    params: {
-      model: &#34;claude-opus-4-6&#34;,
-      max_tokens: 1024,
-      system: [
-        {
-          type: &#34;text&#34;,
-          text: &#34;You are an AI assistant tasked with analyzing literary works. Your goal is to provide insightful commentary on themes, characters, and writing style.\n&#34;
-        },
-        {
-          type: &#34;text&#34;,
-          text: &#34;&lt;the entire contents of Pride and Prejudice&gt;&#34;,
-          cache_control: { type: &#34;ephemeral&#34; }
-        }
-      ],
-      messages: [
-        { role: &#34;user&#34;, content: &#34;Write a summary of Pride and Prejudice.&#34; }
-      ]
-    }
-  }]
+  ]
 });
 ```
 
</code></pre>
    </div>
</body>
</html>