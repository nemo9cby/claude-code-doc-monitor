<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>agents-and-tools/tool-use/tool-search-tool - Diff Report</title>
    <link rel="stylesheet" href="../../css/diff.css">
    <style>
        :root {
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --text-color: #eee;
            --accent: #0f3460;
            --add-bg: #1a4d1a;
            --del-bg: #4d1a1a;
            --add-text: #4ade80;
            --del-text: #f87171;
        }
        @media (prefers-color-scheme: light) {
            :root {
                --bg-color: #f5f5f5;
                --card-bg: #fff;
                --text-color: #333;
                --accent: #e0e0e0;
                --add-bg: #d4edda;
                --del-bg: #f8d7da;
                --add-text: #155724;
                --del-text: #721c24;
            }
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 2rem;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header { margin-bottom: 2rem; }
        h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .meta { color: #888; font-size: 0.9rem; }
        .summary {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: flex;
            gap: 2rem;
        }
        .stat { display: flex; align-items: center; gap: 0.5rem; }
        .stat.added { color: var(--add-text); }
        .stat.removed { color: var(--del-text); }
        .analysis {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border-left: 4px solid #8b5cf6;
        }
        .analysis-header {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #8b5cf6;
        }
        .analysis-content {
            white-space: pre-wrap;
            font-size: 0.95rem;
            line-height: 1.7;
        }
        .diff-container {
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
        }
        .diff-header {
            background: var(--accent);
            padding: 0.75rem 1rem;
            font-weight: 600;
        }
        .diff-content {
            padding: 1rem;
            overflow-x: auto;
        }
        .diff-content ins {
            background: var(--add-bg);
            color: var(--add-text);
            text-decoration: none;
            padding: 0.1em 0.2em;
            border-radius: 2px;
        }
        .diff-content del {
            background: var(--del-bg);
            color: var(--del-text);
            text-decoration: line-through;
            padding: 0.1em 0.2em;
            border-radius: 2px;
        }
        pre {
            background: var(--accent);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.85rem;
            margin-top: 2rem;
        }
        a { color: #60a5fa; }
        .back-link { margin-bottom: 1rem; display: inline-block; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">&larr; Back to daily report</a>

        <header>
            <h1>agents-and-tools/tool-use/tool-search-tool.md</h1>
            <p class="meta">Changed on 2026-01-06 14:35:17 UTC</p>
        </header>

        <div class="summary">
            <div class="stat added">
                <span>+410</span> lines added
            </div>
            <div class="stat removed">
                <span>-0</span> lines removed
            </div>
        </div>

        
        <div class="analysis">
            <div class="analysis-header">ðŸ¤– AI Analysis</div>
            <div class="analysis-content"># Documentation Change Analysis

## Summary
The documentation for the tool search tool has been significantly expanded, introducing a new feature that allows Claude to dynamically discover and load tools on-demand, enhancing context efficiency and tool selection accuracy.

## Key Changes
- **Introduction of Tool Search Tool**: A new mechanism for Claude to search and load tools dynamically, rather than loading all tools upfront.
- **Context Efficiency**: Highlights how the new approach conserves context window space, crucial for applications with numerous tools.
- **Two Search Variants**: Details on two search methods (Regex and BM25) for tool discovery, allowing for more flexible querying.
- **Implementation Guidance**: Comprehensive examples in multiple programming languages (Shell, Python, TypeScript) for integrating the tool search functionality.
- **Error Handling and Best Practices**: New sections on common errors, usage limits, and optimization tips to help developers effectively utilize the tool search feature.

## Impact
**High**: This change introduces a substantial new feature that can significantly improve the efficiency of tool management in applications using Claude, making it essential for developers to understand and implement effectively.</div>
        </div>
        

        <div class="diff-container">
            <div class="diff-header">Visual Diff</div>
            <div class="diff-content"><ins style="background:#e6ffe6;"># Tool search tool&para;<br>&para;<br>---&para;<br>&para;<br>The tool search tool enables Claude to work with hundreds or thousands of tools by dynamically discovering and loading them on-demand. Instead of loading all tool definitions into the context window upfront, Claude searches your tool catalogâ€”including tool names, descriptions, argument names, and argument descriptionsâ€”and loads only the tools it needs.&para;<br>&para;<br>This approach solves two critical challenges as tool libraries scale:&para;<br>&para;<br>- **Context efficiency**: Tool definitions can consume massive portions of your context window (50 tools â‰ˆ 10-20K tokens), leaving less room for actual work&para;<br>- **Tool selection accuracy**: Claude's ability to correctly select tools degrades significantly with more than 30-50 conventionally-available tools&para;<br>&para;<br>Although this is provided as a server-side tool, you can also implement your own client-side tool search functionality. See [Custom tool search implementation](#custom-tool-search-implementation) for details.&para;<br>&para;<br>&lt;Note&gt;&para;<br>The tool search tool is currently in public beta. Include the appropriate [beta header](/docs/en/api/beta-headers) for your provider:&para;<br>&para;<br>| Provider                 | Beta header                    | Supported models                       |&para;<br>| ------------------------ | ------------------------------ | -------------------------------------- |&para;<br>| Claude API&lt;br/&gt;Microsoft Foundry  | `advanced-tool-use-2025-11-20` | Claude Opus 4.5&lt;br /&gt;Claude Sonnet 4.5 |&para;<br>| Google Cloud's Vertex AI | `tool-search-tool-2025-10-19`  | Claude Opus 4.5&lt;br /&gt;Claude Sonnet 4.5 |&para;<br>| Amazon Bedrock           | `tool-search-tool-2025-10-19`  | Claude Opus 4.5                        |&para;<br>&para;<br>Please reach out through our [feedback form](https://forms.gle/MhcGFFwLxuwnWTkYA) to share your feedback on this feature.&para;<br>&lt;/Note&gt;&para;<br>&para;<br>&lt;Warning&gt;&para;<br>  On Amazon Bedrock, server-side tool search is available only via the [invoke&para;<br>  API](https://docs.aws.amazon.com/bedrock/latest/userguide/bedrock-runtime_example_bedrock-runtime_InvokeModel_AnthropicClaude_section.html),&para;<br>  not the converse API.&para;<br>&lt;/Warning&gt;&para;<br>&para;<br>You can also implement [client-side tool search](#custom-tool-search-implementation) by returning `tool_reference` blocks from your own search implementation.&para;<br>&para;<br>## How tool search works&para;<br>&para;<br>There are two tool search variants:&para;<br>&para;<br>- **Regex** (`tool_search_tool_regex_20251119`): Claude constructs regex patterns to search for tools&para;<br>- **BM25** (`tool_search_tool_bm25_20251119`): Claude uses natural language queries to search for tools&para;<br>&para;<br>When you enable the tool search tool:&para;<br>&para;<br>1. You include a tool search tool (e.g., `tool_search_tool_regex_20251119` or `tool_search_tool_bm25_20251119`) in your tools list&para;<br>2. You provide all tool definitions with `defer_loading: true` for tools that shouldn't be loaded immediately&para;<br>3. Claude sees only the tool search tool and any non-deferred tools initially&para;<br>4. When Claude needs additional tools, it searches using a tool search tool&para;<br>5. The API returns 3-5 most relevant `tool_reference` blocks&para;<br>6. These references are automatically expanded into full tool definitions&para;<br>7. Claude selects from the discovered tools and invokes them&para;<br>&para;<br>This keeps your context window efficient while maintaining high tool selection accuracy.&para;<br>&para;<br>## Quick start&para;<br>&para;<br>Here's a simple example with deferred tools:&para;<br>&para;<br>&lt;CodeGroup&gt;&para;<br>```bash Shell&para;<br>curl https://api.anthropic.com/v1/messages \&para;<br>    --header "x-api-key: $ANTHROPIC_API_KEY" \&para;<br>    --header "anthropic-version: 2023-06-01" \&para;<br>    --header "anthropic-beta: advanced-tool-use-2025-11-20" \&para;<br>    --header "content-type: application/json" \&para;<br>    --data '{&para;<br>        "model": "claude-sonnet-4-5-20250929",&para;<br>        "max_tokens": 2048,&para;<br>        "messages": [&para;<br>            {&para;<br>                "role": "user",&para;<br>                "content": "What is the weather in San Francisco?"&para;<br>            }&para;<br>        ],&para;<br>        "tools": [&para;<br>            {&para;<br>                "type": "tool_search_tool_regex_20251119",&para;<br>                "name": "tool_search_tool_regex"&para;<br>            },&para;<br>            {&para;<br>                "name": "get_weather",&para;<br>                "description": "Get the weather at a specific location",&para;<br>                "input_schema": {&para;<br>                    "type": "object",&para;<br>                    "properties": {&para;<br>                        "location": {"type": "string"},&para;<br>                        "unit": {&para;<br>                            "type": "string",&para;<br>                            "enum": ["celsius", "fahrenheit"]&para;<br>                        }&para;<br>                    },&para;<br>                    "required": ["location"]&para;<br>                },&para;<br>                "defer_loading": true&para;<br>            },&para;<br>            {&para;<br>                "name": "search_files",&para;<br>                "description": "Search through files in the workspace",&para;<br>                "input_schema": {&para;<br>                    "type": "object",&para;<br>                    "properties": {&para;<br>                        "query": {"type": "string"},&para;<br>                        "file_types": {&para;<br>                            "type": "array",&para;<br>                            "items": {"type": "string"}&para;<br>                        }&para;<br>                    },&para;<br>                    "required": ["query"]&para;<br>                },&para;<br>                "defer_loading": true&para;<br>            }&para;<br>        ]&para;<br>    }'&para;<br>```&para;<br>&para;<br>```python Python&para;<br>import anthropic&para;<br>&para;<br>client = anthropic.Anthropic()&para;<br>&para;<br>response = client.beta.messages.create(&para;<br>    model="claude-sonnet-4-5-20250929",&para;<br>    betas=["advanced-tool-use-2025-11-20"],&para;<br>    max_tokens=2048,&para;<br>    messages=[&para;<br>        {&para;<br>            "role": "user",&para;<br>            "content": "What is the weather in San Francisco?"&para;<br>        }&para;<br>    ],&para;<br>    tools=[&para;<br>        {&para;<br>            "type": "tool_search_tool_regex_20251119",&para;<br>            "name": "tool_search_tool_regex"&para;<br>        },&para;<br>        {&para;<br>            "name": "get_weather",&para;<br>            "description": "Get the weather at a specific location",&para;<br>            "input_schema": {&para;<br>                "type": "object",&para;<br>                "properties": {&para;<br>                    "location": {"type": "string"},&para;<br>                    "unit": {&para;<br>                        "type": "string",&para;<br>                        "enum": ["celsius", "fahrenheit"]&para;<br>                    }&para;<br>                },&para;<br>                "required": ["location"]&para;<br>            },&para;<br>            "defer_loading": True&para;<br>        },&para;<br>        {&para;<br>            "name": "search_files",&para;<br>            "description": "Search through files in the workspace",&para;<br>            "input_schema": {&para;<br>                "type": "object",&para;<br>                "properties": {&para;<br>                    "query": {"type": "string"},&para;<br>                    "file_types": {&para;<br>                        "type": "array",&para;<br>                        "items": {"type": "string"}&para;<br>                    }&para;<br>                },&para;<br>                "required": ["query"]&para;<br>            },&para;<br>            "defer_loading": True&para;<br>        }&para;<br>    ]&para;<br>)&para;<br>&para;<br>print(response)&para;<br>```&para;<br>&para;<br>```typescript TypeScript&para;<br>import Anthropic from "@anthropic-ai/sdk";&para;<br>&para;<br>const client = new Anthropic();&para;<br>&para;<br>async function main() {&para;<br>  const response = await client.beta.messages.create({&para;<br>    model: "claude-sonnet-4-5-20250929",&para;<br>    betas: ["advanced-tool-use-2025-11-20"],&para;<br>    max_tokens: 2048,&para;<br>    messages: [&para;<br>      {&para;<br>        role: "user",&para;<br>        content: "What is the weather in San Francisco?",&para;<br>      },&para;<br>    ],&para;<br>    tools: [&para;<br>      {&para;<br>        type: "tool_search_tool_regex_20251119",&para;<br>        name: "tool_search_tool_regex",&para;<br>      },&para;<br>      {&para;<br>        name: "get_weather",&para;<br>        description: "Get the weather at a specific location",&para;<br>        input_schema: {&para;<br>          type: "object",&para;<br>          properties: {&para;<br>            location: { type: "string" },&para;<br>            unit: {&para;<br>              type: "string",&para;<br>              enum: ["celsius", "fahrenheit"],&para;<br>            },&para;<br>          },&para;<br>          required: ["location"],&para;<br>        },&para;<br>        defer_loading: true,&para;<br>      },&para;<br>      {&para;<br>        name: "search_files",&para;<br>        description: "Search through files in the workspace",&para;<br>        input_schema: {&para;<br>          type: "object",&para;<br>          properties: {&para;<br>            query: { type: "string" },&para;<br>            file_types: {&para;<br>              type: "array",&para;<br>              items: { type: "string" },&para;<br>            },&para;<br>          },&para;<br>          required: ["query"],&para;<br>        },&para;<br>        defer_loading: true,&para;<br>      },&para;<br>    ],&para;<br>  });&para;<br>&para;<br>  console.log(JSON.stringify(response, null, 2));&para;<br>}&para;<br>&para;<br>main();&para;<br>```&para;<br>&para;<br>&lt;/CodeGroup&gt;&para;<br>&para;<br>## Tool definition&para;<br>&para;<br>The tool search tool has two variants:&para;<br>&para;<br>```json JSON&para;<br>{&para;<br>  "type": "tool_search_tool_regex_20251119",&para;<br>  "name": "tool_search_tool_regex"&para;<br>}&para;<br>```&para;<br>&para;<br>```json JSON&para;<br>{&para;<br>  "type": "tool_search_tool_bm25_20251119",&para;<br>  "name": "tool_search_tool_bm25"&para;<br>}&para;<br>```&para;<br>&para;<br>&lt;Warning&gt;&para;<br>**Regex variant query format: Python regex, NOT natural language**&para;<br>&para;<br>When using `tool_search_tool_regex_20251119`, Claude constructs regex patterns using Python's `re.search()` syntax, not natural language queries. Common patterns:&para;<br>&para;<br>- `"weather"` - matches tool names/descriptions containing "weather"&para;<br>- `"get_.*_data"` - matches tools like `get_user_data`, `get_weather_data`&para;<br>- `"database.*query|query.*database"` - OR patterns for flexibility&para;<br>- `"(?i)slack"` - case-insensitive search&para;<br>&para;<br>Maximum query length: 200 characters&para;<br>&para;<br>&lt;/Warning&gt;&para;<br>&para;<br>&lt;Note&gt;&para;<br>**BM25 variant query format: Natural language**&para;<br>&para;<br>When using `tool_search_tool_bm25_20251119`, Claude uses natural language queries to search for tools.&para;<br>&para;<br>&lt;/Note&gt;&para;<br>&para;<br>### Deferred tool loading&para;<br>&para;<br>Mark tools for on-demand loading by adding `defer_loading: true`:&para;<br>&para;<br>```json JSON&para;<br>{&para;<br>  "name": "get_weather",&para;<br>  "description": "Get current weather for a location",&para;<br>  "input_schema": {&para;<br>    "type": "object",&para;<br>    "properties": {&para;<br>      "location": { "type": "string" },&para;<br>      "unit": { "type": "string", "enum": ["celsius", "fahrenheit"] }&para;<br>    },&para;<br>    "required": ["location"]&para;<br>  },&para;<br>  "defer_loading": true&para;<br>}&para;<br>```&para;<br>&para;<br>**Key points:**&para;<br>&para;<br>- Tools without `defer_loading` are loaded into context immediately&para;<br>- Tools with `defer_loading: true` are only loaded when Claude discovers them via search&para;<br>- The tool search tool itself should **never** have `defer_loading: true`&para;<br>- Keep your 3-5 most frequently used tools as non-deferred for optimal performance&para;<br>&para;<br>Both tool search variants (`regex` and `bm25`) search tool names, descriptions, argument names, and argument descriptions.&para;<br>&para;<br>## Response format&para;<br>&para;<br>When Claude uses the tool search tool, the response includes new block types:&para;<br>&para;<br>```json JSON&para;<br>{&para;<br>  "role": "assistant",&para;<br>  "content": [&para;<br>    {&para;<br>      "type": "text",&para;<br>      "text": "I'll search for tools to help with the weather information."&para;<br>    },&para;<br>    {&para;<br>      "type": "server_tool_use",&para;<br>      "id": "srvtoolu_01ABC123",&para;<br>      "name": "tool_search_tool_regex",&para;<br>      "input": {&para;<br>        "query": "weather"&para;<br>      }&para;<br>    },&para;<br>    {&para;<br>      "type": "tool_search_tool_result",&para;<br>      "tool_use_id": "srvtoolu_01ABC123",&para;<br>      "content": {&para;<br>        "type": "tool_search_tool_search_result",&para;<br>        "tool_references": [{ "type": "tool_reference", "tool_name": "get_weather" }]&para;<br>      }&para;<br>    },&para;<br>    {&para;<br>      "type": "text",&para;<br>      "text": "I found a weather tool. Let me get the weather for San Francisco."&para;<br>    },&para;<br>    {&para;<br>      "type": "tool_use",&para;<br>      "id": "toolu_01XYZ789",&para;<br>      "name": "get_weather",&para;<br>      "input": { "location": "San Francisco", "unit": "fahrenheit" }&para;<br>    }&para;<br>  ],&para;<br>  "stop_reason": "tool_use"&para;<br>}&para;<br>```&para;<br>&para;<br>### Understanding the response&para;<br>&para;<br>- **`server_tool_use`**: Indicates Claude is invoking the tool search tool&para;<br>- **`tool_search_tool_result`**: Contains the search results with a nested `tool_search_tool_search_result` object&para;<br>- **`tool_references`**: Array of `tool_reference` objects pointing to discovered tools&para;<br>- **`tool_use`**: Claude invoking the discovered tool&para;<br>&para;<br>The `tool_reference` blocks are automatically expanded into full tool definitions before being shown to Claude. You don't need to handle this expansion yourself. It happens automatically in the API as long as you provide all matching tool definitions in the `tools` parameter.&para;<br>&para;<br>## MCP integration&para;<br>&para;<br>The tool search tool works with [MCP servers](/docs/en/agents-and-tools/mcp-connector). Add the `"mcp-client-2025-11-20"` [beta header](/docs/en/api/beta-headers) to your API request, and then use `mcp_toolset` with `default_config` to defer loading MCP tools:&para;<br>&para;<br>&lt;CodeGroup&gt;&para;<br>```bash Shell&para;<br>curl https://api.anthropic.com/v1/messages \&para;<br>  --header "x-api-key: $ANTHROPIC_API_KEY" \&para;<br>  --header "anthropic-version: 2023-06-01" \&para;<br>  --header "anthropic-beta: advanced-tool-use-2025-11-20,mcp-client-2025-11-20" \&para;<br>  --header "content-type: application/json" \&para;<br>  --data '{&para;<br>    "model": "claude-sonnet-4-5-20250929",&para;<br>    "max_tokens": 2048,&para;<br>    "mcp_servers": [&para;<br>      {&para;<br>        "type": "url",&para;<br>        "name": "database-server",&para;<br>        "url": "https://mcp-db.example.com"&para;<br>      }&para;<br>    ],&para;<br>    "tools": [&para;<br>      {&para;<br>        "type": "tool_search_tool_regex_20251119",&para;<br>        "name": "tool_search_tool_regex"&para;<br>      },&para;<br>      {&para;<br>        "type": "mcp_toolset",&para;<br>        "mcp_server_name": "database-server",&para;<br>        "default_config": {&para;<br>          "defer_loading": true&para;<br>        },&para;<br>        "configs": {&para;<br>          "search_events": {&para;<br>            "defer_loading": false&para;<br>          }&para;<br>        }&para;<br>      }&para;<br>    ],&para;<br>    "messages": [&para;<br>      {&para;<br>        "role": "user",&para;<br>        "content": "What events are in my database?"&para;<br>      }&para;<br>    ]&para;<br>  }'&para;<br>```&para;<br>&para;<br>```python Python&para;<br>import anthropic&para;<br>&para;<br>client = anthropic.Anthropic()&para;<br>&para;<br>response = client.beta.messages.create(&para;<br>    model="claude-sonnet-4-5-20250929",&para;<br>    betas=["advanced-tool-use-2025-11-20", "mcp-client-2025-11-20"],&para;<br>    max_tokens=2048,&para;<br>    mcp_servers=[&para;<br>        {&para;<br>            "type": "url",&para;<br>            "name": "database-server",&para;<br>            "url": "https://mcp-db.example.com"&para;<br>        }&para;<br>    ],&para;<br>    tools=[&para;<br>        {&para;<br>            "type": "tool_search_tool_regex_20251119",&para;<br>            "name": "tool_search_tool_regex"&para;<br>        },&para;<br>        {&para;<br>            "type": "mcp_toolset",&para;<br>            "mcp_server_name": "database-server",&para;<br>            "default_config": {&para;<br>                "defer_loading": True&para;<br>            },&para;<br>            "configs": {&para;<br>                "search_events": {&para;<br>                    "defer_loading": False&para;<br>                }&para;<br>            }&para;<br>        }&para;<br>    ],&para;<br>    messages=[&para;<br>        {&para;<br>            "role": "user",&para;<br>            "content": "What events are in my database?"&para;<br>        }&para;<br>    ]&para;<br>)&para;<br>&para;<br>print(response)&para;<br>```&para;<br>&para;<br>```typescript TypeScript&para;<br>import Anthropic from "@anthropic-ai/sdk";&para;<br>&para;<br>const client = new Anthropic();&para;<br>&para;<br>async function main() {&para;<br>  const response = await client.beta.messages.create({&para;<br>    model: "claude-sonnet-4-5-20250929",&para;<br>    betas: ["advanced-tool-use-2025-11-20", "mcp-client-2025-11-20"],&para;<br>    max_tokens: 2048,&para;<br>    mcp_servers: [&para;<br>      {&para;<br>        type: "url",&para;<br>        name: "database-server",&para;<br>        url: "https://mcp-db.example.com",&para;<br>      },&para;<br>    ],&para;<br>    tools: [&para;<br>      {&para;<br>        type: "tool_search_tool_regex_20251119",&para;<br>        name: "tool_search_tool_regex",&para;<br>      },&para;<br>      {&para;<br>        type: "mcp_toolset",&para;<br>        mcp_server_name: "database-server",&para;<br>        default_config: {&para;<br>          defer_loading: true,&para;<br>        },&para;<br>        configs: {&para;<br>          search_events: {&para;<br>            defer_loading: false,&para;<br>          },&para;<br>        },&para;<br>      },&para;<br>    ],&para;<br>    messages: [&para;<br>      {&para;<br>        role: "user",&para;<br>        content: "What events are in my database?",&para;<br>      },&para;<br>    ],&para;<br>  });&para;<br>&para;<br>  console.log(JSON.stringify(response, null, 2));&para;<br>}&para;<br>&para;<br>main();&para;<br>```&para;<br>&para;<br>&lt;/CodeGroup&gt;&para;<br>&para;<br>**MCP configuration options:**&para;<br>&para;<br>- `default_config.defer_loading`: Set default for all tools from the MCP server&para;<br>- `configs`: Override defaults for specific tools by name&para;<br>- Combine multiple MCP servers with tool search for massive tool libraries&para;<br>&para;<br>## Custom tool search implementation&para;<br>&para;<br>You can implement your own tool search logic (e.g., using embeddings or semantic search) by returning `tool_reference` blocks from a custom tool. When Claude calls your custom search tool, return a standard `tool_result` with `tool_reference` blocks in the content array:&para;<br>&para;<br>```json JSON&para;<br>{&para;<br>  "type": "tool_result",&para;<br>  "tool_use_id": "toolu_your_tool_id",&para;<br>  "content": [&para;<br>    { "type": "tool_reference", "tool_name": "discovered_tool_name" }&para;<br>  ]&para;<br>}&para;<br>```&para;<br>&para;<br>Every tool referenced must have a corresponding tool definition in the top-level `tools` parameter with `defer_loading: true`. This approach lets you use more sophisticated search algorithms while maintaining compatibility with the tool search system.&para;<br>&para;<br>&lt;Note&gt;&para;<br>The `tool_search_tool_result` format shown in the [Response format](#response-format) section is the server-side format used internally by Anthropic's built-in tool search. For custom client-side implementations, always use the standard `tool_result` format with `tool_reference` content blocks as shown above.&para;<br>&lt;/Note&gt;&para;<br>&para;<br>For a complete example using embeddings, see our [tool search with embeddings cookbook](https://github.com/anthropics/anthropic-cookbook).&para;<br>&para;<br>## Error handling&para;<br>&para;<br>&lt;Note&gt;&para;<br>  The tool search tool is not compatible with [tool use&para;<br>  examples](/docs/en/agents-and-tools/tool-use/implement-tool-use#providing-tool-use-examples).&para;<br>  If you need to provide examples of tool usage, use standard tool calling&para;<br>  without tool search.&para;<br>&lt;/Note&gt;&para;<br>&para;<br>### HTTP errors (400 status)&para;<br>&para;<br>These errors prevent the request from being processed:&para;<br>&para;<br>**All tools deferred:**&para;<br>&para;<br>```json&para;<br>{&para;<br>  "type": "error",&para;<br>  "error": {&para;<br>    "type": "invalid_request_error",&para;<br>    "message": "All tools have defer_loading set. At least one tool must be non-deferred."&para;<br>  }&para;<br>}&para;<br>```&para;<br>&para;<br>**Missing tool definition:**&para;<br>&para;<br>```json&para;<br>{&para;<br>  "type": "error",&para;<br>  "error": {&para;<br>    "type": "invalid_request_error",&para;<br>    "message": "Tool reference 'unknown_tool' has no corresponding tool definition"&para;<br>  }&para;<br>}&para;<br>```&para;<br>&para;<br>### Tool result errors (200 status)&para;<br>&para;<br>Errors during tool execution return a 200 response with error information in the body:&para;<br>&para;<br>```json JSON&para;<br>{&para;<br>  "type": "tool_result",&para;<br>  "tool_use_id": "srvtoolu_01ABC123",&para;<br>  "content": {&para;<br>    "type": "tool_search_tool_result_error",&para;<br>    "error_code": "invalid_pattern"&para;<br>  }&para;<br>}&para;<br>```&para;<br>&para;<br>**Error codes:**&para;<br>&para;<br>- `too_many_requests`: Rate limit exceeded for tool search operations&para;<br>- `invalid_pattern`: Malformed regex pattern&para;<br>- `pattern_too_long`: Pattern exceeds 200 character limit&para;<br>- `unavailable`: Tool search service temporarily unavailable&para;<br>&para;<br>### Common mistakes&para;<br>&para;<br>&lt;section title="400 Error: All tools are deferred"&gt;&para;<br>&para;<br>**Cause**: You set `defer_loading: true` on ALL tools including the search tool&para;<br>&para;<br>**Fix**: Remove `defer_loading` from the tool search tool:&para;<br>&para;<br>```json&para;<br>{&para;<br>  "type": "tool_search_tool_regex_20251119", // No defer_loading here&para;<br>  "name": "tool_search_tool_regex"&para;<br>}&para;<br>```&para;<br>&para;<br>&lt;/section&gt;&para;<br>&para;<br>&lt;section title="400 Error: Missing tool definition"&gt;&para;<br>&para;<br>**Cause**: A `tool_reference` points to a tool not in your `tools` array&para;<br>&para;<br>**Fix**: Ensure every tool that could be discovered has a complete definition:&para;<br>&para;<br>```json&para;<br>{&para;<br>  "name": "my_tool",&para;<br>  "description": "Full description here",&para;<br>  "input_schema": {&para;<br>    /* complete schema */&para;<br>  },&para;<br>  "defer_loading": true&para;<br>}&para;<br>```&para;<br>&para;<br>&lt;/section&gt;&para;<br>&para;<br>&lt;section title="Claude doesn't find expected tools"&gt;&para;<br>&para;<br>**Cause**: Tool names or descriptions don't match the regex pattern&para;<br>&para;<br>**Debugging steps:**&para;<br>&para;<br>1. Check tool name and descriptionâ€”Claude searches BOTH fields&para;<br>2. Test your pattern: `import re; re.search(r"your_pattern", "tool_name")`&para;<br>3. Remember searches are case-sensitive by default (use `(?i)` for case-insensitive)&para;<br>4. Claude uses broad patterns like `".*weather.*"` not exact matches&para;<br>&para;<br>**Tip**: Add common keywords to tool descriptions to improve discoverability&para;<br>&para;<br>&lt;/section&gt;&para;<br>&para;<br>## Prompt caching&para;<br>&para;<br>Tool search works with [prompt caching](/docs/en/build-with-claude/prompt-caching). Add `cache_control` breakpoints to optimize multi-turn conversations:&para;<br>&para;<br>&lt;CodeGroup&gt;&para;<br>```python Python&para;<br>import anthropic&para;<br>&para;<br>client = anthropic.Anthropic()&para;<br>&para;<br># First request with tool search&para;<br>messages = [&para;<br>    {&para;<br>        "role": "user",&para;<br>        "content": "What's the weather in Seattle?"&para;<br>    }&para;<br>]&para;<br>&para;<br>response1 = client.beta.messages.create(&para;<br>    model="claude-sonnet-4-5-20250929",&para;<br>    betas=["advanced-tool-use-2025-11-20"],&para;<br>    max_tokens=2048,&para;<br>    messages=messages,&para;<br>    tools=[&para;<br>        {&para;<br>            "type": "tool_search_tool_regex_20251119",&para;<br>            "name": "tool_search_tool_regex"&para;<br>        },&para;<br>        {&para;<br>            "name": "get_weather",&para;<br>            "description": "Get weather for a location",&para;<br>            "input_schema": {&para;<br>                "type": "object",&para;<br>                "properties": {&para;<br>                    "location": {"type": "string"}&para;<br>                },&para;<br>                "required": ["location"]&para;<br>            },&para;<br>            "defer_loading": True&para;<br>        }&para;<br>    ]&para;<br>)&para;<br>&para;<br># Add Claude's response to conversation&para;<br>messages.append({&para;<br>    "role": "assistant",&para;<br>    "content": response1.content&para;<br>})&para;<br>&para;<br># Second request with cache breakpoint&para;<br>messages.append({&para;<br>    "role": "user",&para;<br>    "content": "What about New York?",&para;<br>    "cache_control": {"type": "ephemeral"}&para;<br>})&para;<br>&para;<br>response2 = client.beta.messages.create(&para;<br>    model="claude-sonnet-4-5-20250929",&para;<br>    betas=["advanced-tool-use-2025-11-20"],&para;<br>    max_tokens=2048,&para;<br>    messages=messages,&para;<br>    tools=[&para;<br>        {&para;<br>            "type": "tool_search_tool_regex_20251119",&para;<br>            "name": "tool_search_tool_regex"&para;<br>        },&para;<br>        {&para;<br>            "name": "get_weather",&para;<br>            "description": "Get weather for a location",&para;<br>            "input_schema": {&para;<br>                "type": "object",&para;<br>                "properties": {&para;<br>                    "location": {"type": "string"}&para;<br>                },&para;<br>                "required": ["location"]&para;<br>            },&para;<br>            "defer_loading": True&para;<br>        }&para;<br>    ]&para;<br>)&para;<br>&para;<br>print(f"Cache read tokens: {response2.usage.get('cache_read_input_tokens', 0)}")&para;<br>```&para;<br>&lt;/CodeGroup&gt;&para;<br>&para;<br>The system automatically expands tool_reference blocks throughout the entire conversation history, so Claude can reuse discovered tools in subsequent turns without re-searching.&para;<br>&para;<br>## Streaming&para;<br>&para;<br>With streaming enabled, you'll receive tool search events as part of the stream:&para;<br>&para;<br>```javascript&para;<br>event: content_block_start&para;<br>data: {"type": "content_block_start", "index": 1, "content_block": {"type": "server_tool_use", "id": "srvtoolu_xyz789", "name": "tool_search_tool_regex"}}&para;<br>&para;<br>// Search query streamed&para;<br>event: content_block_delta&para;<br>data: {"type": "content_block_delta", "index": 1, "delta": {"type": "input_json_delta", "partial_json": "{\"query\":\"weather\"}"}}&para;<br>&para;<br>// Pause while search executes&para;<br>&para;<br>// Search results streamed&para;<br>event: content_block_start&para;<br>data: {"type": "content_block_start", "index": 2, "content_block": {"type": "tool_search_tool_result", "tool_use_id": "srvtoolu_xyz789", "content": {"type": "tool_search_tool_search_result", "tool_references": [{"type": "tool_reference", "tool_name": "get_weather"}]}}}&para;<br>&para;<br>// Claude continues with discovered tools&para;<br>```&para;<br>&para;<br>## Batch requests&para;<br>&para;<br>You can include the tool search tool in the [Messages Batches API](/docs/en/build-with-claude/batch-processing). Tool search operations through the Messages Batches API are priced the same as those in regular Messages API requests.&para;<br>&para;<br>## Limits and best practices&para;<br>&para;<br>### Limits&para;<br>&para;<br>- **Maximum tools**: 10,000 tools in your catalog&para;<br>- **Search results**: Returns 3-5 most relevant tools per search&para;<br>- **Pattern length**: Maximum 200 characters for regex patterns&para;<br>- **Model support**: Sonnet 4.0+, Opus 4.0+ only (no Haiku)&para;<br>&para;<br>### When to use tool search&para;<br>&para;<br>**Good use cases:**&para;<br>&para;<br>- 10+ tools available in your system&para;<br>- Tool definitions consuming &gt;10K tokens&para;<br>- Experiencing tool selection accuracy issues with large tool sets&para;<br>- Building MCP-powered systems with multiple servers (200+ tools)&para;<br>- Tool library growing over time&para;<br>&para;<br>**When traditional tool calling might be better:**&para;<br>&para;<br>- Less than 10 tools total&para;<br>- All tools are frequently used in every request&para;<br>- Very small tool definitions (\&lt;100 tokens total)&para;<br>&para;<br>### Optimization tips&para;<br>&para;<br>- Keep 3-5 most frequently used tools as non-deferred&para;<br>- Write clear, descriptive tool names and descriptions&para;<br>- Use semantic keywords in descriptions that match how users describe tasks&para;<br>- Add a system prompt section describing available tool categories: "You can search for tools to interact with Slack, GitHub, and Jira"&para;<br>- Monitor which tools Claude discovers to refine descriptions&para;<br>&para;<br>## Usage&para;<br>&para;<br>Tool search tool usage is tracked in the response usage object:&para;<br>&para;<br>```json JSON&para;<br>{&para;<br>  "usage": {&para;<br>    "input_tokens": 1024,&para;<br>    "output_tokens": 256,&para;<br>    "server_tool_use": {&para;<br>      "tool_search_requests": 2&para;<br>    }&para;<br>  }&para;<br>}&para;<br>```</ins></div>
        </div>

        <h2 style="margin-top: 2rem; margin-bottom: 1rem;">Unified Diff</h2>
        <pre><code>--- a/agents-and-tools/tool-use/tool-search-tool.md
+++ b/agents-and-tools/tool-use/tool-search-tool.md
@@ -0,0 +1,797 @@
+# Tool search tool
+
+---
+
+The tool search tool enables Claude to work with hundreds or thousands of tools by dynamically discovering and loading them on-demand. Instead of loading all tool definitions into the context window upfront, Claude searches your tool catalogâ€”including tool names, descriptions, argument names, and argument descriptionsâ€”and loads only the tools it needs.
+
+This approach solves two critical challenges as tool libraries scale:
+
+- **Context efficiency**: Tool definitions can consume massive portions of your context window (50 tools â‰ˆ 10-20K tokens), leaving less room for actual work
+- **Tool selection accuracy**: Claude&#39;s ability to correctly select tools degrades significantly with more than 30-50 conventionally-available tools
+
+Although this is provided as a server-side tool, you can also implement your own client-side tool search functionality. See [Custom tool search implementation](#custom-tool-search-implementation) for details.
+
+&lt;Note&gt;
+The tool search tool is currently in public beta. Include the appropriate [beta header](/docs/en/api/beta-headers) for your provider:
+
+| Provider                 | Beta header                    | Supported models                       |
+| ------------------------ | ------------------------------ | -------------------------------------- |
+| Claude API&lt;br/&gt;Microsoft Foundry  | `advanced-tool-use-2025-11-20` | Claude Opus 4.5&lt;br /&gt;Claude Sonnet 4.5 |
+| Google Cloud&#39;s Vertex AI | `tool-search-tool-2025-10-19`  | Claude Opus 4.5&lt;br /&gt;Claude Sonnet 4.5 |
+| Amazon Bedrock           | `tool-search-tool-2025-10-19`  | Claude Opus 4.5                        |
+
+Please reach out through our [feedback form](https://forms.gle/MhcGFFwLxuwnWTkYA) to share your feedback on this feature.
+&lt;/Note&gt;
+
+&lt;Warning&gt;
+  On Amazon Bedrock, server-side tool search is available only via the [invoke
+  API](https://docs.aws.amazon.com/bedrock/latest/userguide/bedrock-runtime_example_bedrock-runtime_InvokeModel_AnthropicClaude_section.html),
+  not the converse API.
+&lt;/Warning&gt;
+
+You can also implement [client-side tool search](#custom-tool-search-implementation) by returning `tool_reference` blocks from your own search implementation.
+
+## How tool search works
+
+There are two tool search variants:
+
+- **Regex** (`tool_search_tool_regex_20251119`): Claude constructs regex patterns to search for tools
+- **BM25** (`tool_search_tool_bm25_20251119`): Claude uses natural language queries to search for tools
+
+When you enable the tool search tool:
+
+1. You include a tool search tool (e.g., `tool_search_tool_regex_20251119` or `tool_search_tool_bm25_20251119`) in your tools list
+2. You provide all tool definitions with `defer_loading: true` for tools that shouldn&#39;t be loaded immediately
+3. Claude sees only the tool search tool and any non-deferred tools initially
+4. When Claude needs additional tools, it searches using a tool search tool
+5. The API returns 3-5 most relevant `tool_reference` blocks
+6. These references are automatically expanded into full tool definitions
+7. Claude selects from the discovered tools and invokes them
+
+This keeps your context window efficient while maintaining high tool selection accuracy.
+
+## Quick start
+
+Here&#39;s a simple example with deferred tools:
+
+&lt;CodeGroup&gt;
+```bash Shell
+curl https://api.anthropic.com/v1/messages \
+    --header &#34;x-api-key: $ANTHROPIC_API_KEY&#34; \
+    --header &#34;anthropic-version: 2023-06-01&#34; \
+    --header &#34;anthropic-beta: advanced-tool-use-2025-11-20&#34; \
+    --header &#34;content-type: application/json&#34; \
+    --data &#39;{
+        &#34;model&#34;: &#34;claude-sonnet-4-5-20250929&#34;,
+        &#34;max_tokens&#34;: 2048,
+        &#34;messages&#34;: [
+            {
+                &#34;role&#34;: &#34;user&#34;,
+                &#34;content&#34;: &#34;What is the weather in San Francisco?&#34;
+            }
+        ],
+        &#34;tools&#34;: [
+            {
+                &#34;type&#34;: &#34;tool_search_tool_regex_20251119&#34;,
+                &#34;name&#34;: &#34;tool_search_tool_regex&#34;
+            },
+            {
+                &#34;name&#34;: &#34;get_weather&#34;,
+                &#34;description&#34;: &#34;Get the weather at a specific location&#34;,
+                &#34;input_schema&#34;: {
+                    &#34;type&#34;: &#34;object&#34;,
+                    &#34;properties&#34;: {
+                        &#34;location&#34;: {&#34;type&#34;: &#34;string&#34;},
+                        &#34;unit&#34;: {
+                            &#34;type&#34;: &#34;string&#34;,
+                            &#34;enum&#34;: [&#34;celsius&#34;, &#34;fahrenheit&#34;]
+                        }
+                    },
+                    &#34;required&#34;: [&#34;location&#34;]
+                },
+                &#34;defer_loading&#34;: true
+            },
+            {
+                &#34;name&#34;: &#34;search_files&#34;,
+                &#34;description&#34;: &#34;Search through files in the workspace&#34;,
+                &#34;input_schema&#34;: {
+                    &#34;type&#34;: &#34;object&#34;,
+                    &#34;properties&#34;: {
+                        &#34;query&#34;: {&#34;type&#34;: &#34;string&#34;},
+                        &#34;file_types&#34;: {
+                            &#34;type&#34;: &#34;array&#34;,
+                            &#34;items&#34;: {&#34;type&#34;: &#34;string&#34;}
+                        }
+                    },
+                    &#34;required&#34;: [&#34;query&#34;]
+                },
+                &#34;defer_loading&#34;: true
+            }
+        ]
+    }&#39;
+```
+
+```python Python
+import anthropic
+
+client = anthropic.Anthropic()
+
+response = client.beta.messages.create(
+    model=&#34;claude-sonnet-4-5-20250929&#34;,
+    betas=[&#34;advanced-tool-use-2025-11-20&#34;],
+    max_tokens=2048,
+    messages=[
+        {
+            &#34;role&#34;: &#34;user&#34;,
+            &#34;content&#34;: &#34;What is the weather in San Francisco?&#34;
+        }
+    ],
+    tools=[
+        {
+            &#34;type&#34;: &#34;tool_search_tool_regex_20251119&#34;,
+            &#34;name&#34;: &#34;tool_search_tool_regex&#34;
+        },
+        {
+            &#34;name&#34;: &#34;get_weather&#34;,
+            &#34;description&#34;: &#34;Get the weather at a specific location&#34;,
+            &#34;input_schema&#34;: {
+                &#34;type&#34;: &#34;object&#34;,
+                &#34;properties&#34;: {
+                    &#34;location&#34;: {&#34;type&#34;: &#34;string&#34;},
+                    &#34;unit&#34;: {
+                        &#34;type&#34;: &#34;string&#34;,
+                        &#34;enum&#34;: [&#34;celsius&#34;, &#34;fahrenheit&#34;]
+                    }
+                },
+                &#34;required&#34;: [&#34;location&#34;]
+            },
+            &#34;defer_loading&#34;: True
+        },
+        {
+            &#34;name&#34;: &#34;search_files&#34;,
+            &#34;description&#34;: &#34;Search through files in the workspace&#34;,
+            &#34;input_schema&#34;: {
+                &#34;type&#34;: &#34;object&#34;,
+                &#34;properties&#34;: {
+                    &#34;query&#34;: {&#34;type&#34;: &#34;string&#34;},
+                    &#34;file_types&#34;: {
+                        &#34;type&#34;: &#34;array&#34;,
+                        &#34;items&#34;: {&#34;type&#34;: &#34;string&#34;}
+                    }
+                },
+                &#34;required&#34;: [&#34;query&#34;]
+            },
+            &#34;defer_loading&#34;: True
+        }
+    ]
+)
+
+print(response)
+```
+
+```typescript TypeScript
+import Anthropic from &#34;@anthropic-ai/sdk&#34;;
+
+const client = new Anthropic();
+
+async function main() {
+  const response = await client.beta.messages.create({
+    model: &#34;claude-sonnet-4-5-20250929&#34;,
+    betas: [&#34;advanced-tool-use-2025-11-20&#34;],
+    max_tokens: 2048,
+    messages: [
+      {
+        role: &#34;user&#34;,
+        content: &#34;What is the weather in San Francisco?&#34;,
+      },
+    ],
+    tools: [
+      {
+        type: &#34;tool_search_tool_regex_20251119&#34;,
+        name: &#34;tool_search_tool_regex&#34;,
+      },
+      {
+        name: &#34;get_weather&#34;,
+        description: &#34;Get the weather at a specific location&#34;,
+        input_schema: {
+          type: &#34;object&#34;,
+          properties: {
+            location: { type: &#34;string&#34; },
+            unit: {
+              type: &#34;string&#34;,
+              enum: [&#34;celsius&#34;, &#34;fahrenheit&#34;],
+            },
+          },
+          required: [&#34;location&#34;],
+        },
+        defer_loading: true,
+      },
+      {
+        name: &#34;search_files&#34;,
+        description: &#34;Search through files in the workspace&#34;,
+        input_schema: {
+          type: &#34;object&#34;,
+          properties: {
+            query: { type: &#34;string&#34; },
+            file_types: {
+              type: &#34;array&#34;,
+              items: { type: &#34;string&#34; },
+            },
+          },
+          required: [&#34;query&#34;],
+        },
+        defer_loading: true,
+      },
+    ],
+  });
+
+  console.log(JSON.stringify(response, null, 2));
+}
+
+main();
+```
+
+&lt;/CodeGroup&gt;
+
+## Tool definition
+
+The tool search tool has two variants:
+
+```json JSON
+{
+  &#34;type&#34;: &#34;tool_search_tool_regex_20251119&#34;,
+  &#34;name&#34;: &#34;tool_search_tool_regex&#34;
+}
+```
+
+```json JSON
+{
+  &#34;type&#34;: &#34;tool_search_tool_bm25_20251119&#34;,
+  &#34;name&#34;: &#34;tool_search_tool_bm25&#34;
+}
+```
+
+&lt;Warning&gt;
+**Regex variant query format: Python regex, NOT natural language**
+
+When using `tool_search_tool_regex_20251119`, Claude constructs regex patterns using Python&#39;s `re.search()` syntax, not natural language queries. Common patterns:
+
+- `&#34;weather&#34;` - matches tool names/descriptions containing &#34;weather&#34;
+- `&#34;get_.*_data&#34;` - matches tools like `get_user_data`, `get_weather_data`
+- `&#34;database.*query|query.*database&#34;` - OR patterns for flexibility
+- `&#34;(?i)slack&#34;` - case-insensitive search
+
+Maximum query length: 200 characters
+
+&lt;/Warning&gt;
+
+&lt;Note&gt;
+**BM25 variant query format: Natural language**
+
+When using `tool_search_tool_bm25_20251119`, Claude uses natural language queries to search for tools.
+
+&lt;/Note&gt;
+
+### Deferred tool loading
+
+Mark tools for on-demand loading by adding `defer_loading: true`:
+
+```json JSON
+{
+  &#34;name&#34;: &#34;get_weather&#34;,
+  &#34;description&#34;: &#34;Get current weather for a location&#34;,
+  &#34;input_schema&#34;: {
+    &#34;type&#34;: &#34;object&#34;,
+    &#34;properties&#34;: {
+      &#34;location&#34;: { &#34;type&#34;: &#34;string&#34; },
+      &#34;unit&#34;: { &#34;type&#34;: &#34;string&#34;, &#34;enum&#34;: [&#34;celsius&#34;, &#34;fahrenheit&#34;] }
+    },
+    &#34;required&#34;: [&#34;location&#34;]
+  },
+  &#34;defer_loading&#34;: true
+}
+```
+
+**Key points:**
+
+- Tools without `defer_loading` are loaded into context immediately
+- Tools with `defer_loading: true` are only loaded when Claude discovers them via search
+- The tool search tool itself should **never** have `defer_loading: true`
+- Keep your 3-5 most frequently used tools as non-deferred for optimal performance
+
+Both tool search variants (`regex` and `bm25`) search tool names, descriptions, argument names, and argument descriptions.
+
+## Response format
+
+When Claude uses the tool search tool, the response includes new block types:
+
+```json JSON
+{
+  &#34;role&#34;: &#34;assistant&#34;,
+  &#34;content&#34;: [
+    {
+      &#34;type&#34;: &#34;text&#34;,
+      &#34;text&#34;: &#34;I&#39;ll search for tools to help with the weather information.&#34;
+    },
+    {
+      &#34;type&#34;: &#34;server_tool_use&#34;,
+      &#34;id&#34;: &#34;srvtoolu_01ABC123&#34;,
+      &#34;name&#34;: &#34;tool_search_tool_regex&#34;,
+      &#34;input&#34;: {
+        &#34;query&#34;: &#34;weather&#34;
+      }
+    },
+    {
+      &#34;type&#34;: &#34;tool_search_tool_result&#34;,
+      &#34;tool_use_id&#34;: &#34;srvtoolu_01ABC123&#34;,
+      &#34;content&#34;: {
+        &#34;type&#34;: &#34;tool_search_tool_search_result&#34;,
+        &#34;tool_references&#34;: [{ &#34;type&#34;: &#34;tool_reference&#34;, &#34;tool_name&#34;: &#34;get_weather&#34; }]
+      }
+    },
+    {
+      &#34;type&#34;: &#34;text&#34;,
+      &#34;text&#34;: &#34;I found a weather tool. Let me get the weather for San Francisco.&#34;
+    },
+    {
+      &#34;type&#34;: &#34;tool_use&#34;,
+      &#34;id&#34;: &#34;toolu_01XYZ789&#34;,
+      &#34;name&#34;: &#34;get_weather&#34;,
+      &#34;input&#34;: { &#34;location&#34;: &#34;San Francisco&#34;, &#34;unit&#34;: &#34;fahrenheit&#34; }
+    }
+  ],
+  &#34;stop_reason&#34;: &#34;tool_use&#34;
+}
+```
+
+### Understanding the response
+
+- **`server_tool_use`**: Indicates Claude is invoking the tool search tool
+- **`tool_search_tool_result`**: Contains the search results with a nested `tool_search_tool_search_result` object
+- **`tool_references`**: Array of `tool_reference` objects pointing to discovered tools
+- **`tool_use`**: Claude invoking the discovered tool
+
+The `tool_reference` blocks are automatically expanded into full tool definitions before being shown to Claude. You don&#39;t need to handle this expansion yourself. It happens automatically in the API as long as you provide all matching tool definitions in the `tools` parameter.
+
+## MCP integration
+
+The tool search tool works with [MCP servers](/docs/en/agents-and-tools/mcp-connector). Add the `&#34;mcp-client-2025-11-20&#34;` [beta header](/docs/en/api/beta-headers) to your API request, and then use `mcp_toolset` with `default_config` to defer loading MCP tools:
+
+&lt;CodeGroup&gt;
+```bash Shell
+curl https://api.anthropic.com/v1/messages \
+  --header &#34;x-api-key: $ANTHROPIC_API_KEY&#34; \
+  --header &#34;anthropic-version: 2023-06-01&#34; \
+  --header &#34;anthropic-beta: advanced-tool-use-2025-11-20,mcp-client-2025-11-20&#34; \
+  --header &#34;content-type: application/json&#34; \
+  --data &#39;{
+    &#34;model&#34;: &#34;claude-sonnet-4-5-20250929&#34;,
+    &#34;max_tokens&#34;: 2048,
+    &#34;mcp_servers&#34;: [
+      {
+        &#34;type&#34;: &#34;url&#34;,
+        &#34;name&#34;: &#34;database-server&#34;,
+        &#34;url&#34;: &#34;https://mcp-db.example.com&#34;
+      }
+    ],
+    &#34;tools&#34;: [
+      {
+        &#34;type&#34;: &#34;tool_search_tool_regex_20251119&#34;,
+        &#34;name&#34;: &#34;tool_search_tool_regex&#34;
+      },
+      {
+        &#34;type&#34;: &#34;mcp_toolset&#34;,
+        &#34;mcp_server_name&#34;: &#34;database-server&#34;,
+        &#34;default_config&#34;: {
+          &#34;defer_loading&#34;: true
+        },
+        &#34;configs&#34;: {
+          &#34;search_events&#34;: {
+            &#34;defer_loading&#34;: false
+          }
+        }
+      }
+    ],
+    &#34;messages&#34;: [
+      {
+        &#34;role&#34;: &#34;user&#34;,
+        &#34;content&#34;: &#34;What events are in my database?&#34;
+      }
+    ]
+  }&#39;
+```
+
+```python Python
+import anthropic
+
+client = anthropic.Anthropic()
+
+response = client.beta.messages.create(
+    model=&#34;claude-sonnet-4-5-20250929&#34;,
+    betas=[&#34;advanced-tool-use-2025-11-20&#34;, &#34;mcp-client-2025-11-20&#34;],
+    max_tokens=2048,
+    mcp_servers=[
+        {
+            &#34;type&#34;: &#34;url&#34;,
+            &#34;name&#34;: &#34;database-server&#34;,
+            &#34;url&#34;: &#34;https://mcp-db.example.com&#34;
+        }
+    ],
+    tools=[
+        {
+            &#34;type&#34;: &#34;tool_search_tool_regex_20251119&#34;,
+            &#34;name&#34;: &#34;tool_search_tool_regex&#34;
+        },
+        {
+            &#34;type&#34;: &#34;mcp_toolset&#34;,
+            &#34;mcp_server_name&#34;: &#34;database-server&#34;,
+            &#34;default_config&#34;: {
+                &#34;defer_loading&#34;: True
+            },
+            &#34;configs&#34;: {
+                &#34;search_events&#34;: {
+                    &#34;defer_loading&#34;: False
+                }
+            }
+        }
+    ],
+    messages=[
+        {
+            &#34;role&#34;: &#34;user&#34;,
+            &#34;content&#34;: &#34;What events are in my database?&#34;
+        }
+    ]
+)
+
+print(response)
+```
+
+```typescript TypeScript
+import Anthropic from &#34;@anthropic-ai/sdk&#34;;
+
+const client = new Anthropic();
+
+async function main() {
+  const response = await client.beta.messages.create({
+    model: &#34;claude-sonnet-4-5-20250929&#34;,
+    betas: [&#34;advanced-tool-use-2025-11-20&#34;, &#34;mcp-client-2025-11-20&#34;],
+    max_tokens: 2048,
+    mcp_servers: [
+      {
+        type: &#34;url&#34;,
+        name: &#34;database-server&#34;,
+        url: &#34;https://mcp-db.example.com&#34;,
+      },
+    ],
+    tools: [
+      {
+        type: &#34;tool_search_tool_regex_20251119&#34;,
+        name: &#34;tool_search_tool_regex&#34;,
+      },
+      {
+        type: &#34;mcp_toolset&#34;,
+        mcp_server_name: &#34;database-server&#34;,
+        default_config: {
+          defer_loading: true,
+        },
+        configs: {
+          search_events: {
+            defer_loading: false,
+          },
+        },
+      },
+    ],
+    messages: [
+      {
+        role: &#34;user&#34;,
+        content: &#34;What events are in my database?&#34;,
+      },
+    ],
+  });
+
+  console.log(JSON.stringify(response, null, 2));
+}
+
+main();
+```
+
+&lt;/CodeGroup&gt;
+
+**MCP configuration options:**
+
+- `default_config.defer_loading`: Set default for all tools from the MCP server
+- `configs`: Override defaults for specific tools by name
+- Combine multiple MCP servers with tool search for massive tool libraries
+
+## Custom tool search implementation
+
+You can implement your own tool search logic (e.g., using embeddings or semantic search) by returning `tool_reference` blocks from a custom tool. When Claude calls your custom search tool, return a standard `tool_result` with `tool_reference` blocks in the content array:
+
+```json JSON
+{
+  &#34;type&#34;: &#34;tool_result&#34;,
+  &#34;tool_use_id&#34;: &#34;toolu_your_tool_id&#34;,
+  &#34;content&#34;: [
+    { &#34;type&#34;: &#34;tool_reference&#34;, &#34;tool_name&#34;: &#34;discovered_tool_name&#34; }
+  ]
+}
+```
+
+Every tool referenced must have a corresponding tool definition in the top-level `tools` parameter with `defer_loading: true`. This approach lets you use more sophisticated search algorithms while maintaining compatibility with the tool search system.
+
+&lt;Note&gt;
+The `tool_search_tool_result` format shown in the [Response format](#response-format) section is the server-side format used internally by Anthropic&#39;s built-in tool search. For custom client-side implementations, always use the standard `tool_result` format with `tool_reference` content blocks as shown above.
+&lt;/Note&gt;
+
+For a complete example using embeddings, see our [tool search with embeddings cookbook](https://github.com/anthropics/anthropic-cookbook).
+
+## Error handling
+
+&lt;Note&gt;
+  The tool search tool is not compatible with [tool use
+  examples](/docs/en/agents-and-tools/tool-use/implement-tool-use#providing-tool-use-examples).
+  If you need to provide examples of tool usage, use standard tool calling
+  without tool search.
+&lt;/Note&gt;
+
+### HTTP errors (400 status)
+
+These errors prevent the request from being processed:
+
+**All tools deferred:**
+
+```json
+{
+  &#34;type&#34;: &#34;error&#34;,
+  &#34;error&#34;: {
+    &#34;type&#34;: &#34;invalid_request_error&#34;,
+    &#34;message&#34;: &#34;All tools have defer_loading set. At least one tool must be non-deferred.&#34;
+  }
+}
+```
+
+**Missing tool definition:**
+
+```json
+{
+  &#34;type&#34;: &#34;error&#34;,
+  &#34;error&#34;: {
+    &#34;type&#34;: &#34;invalid_request_error&#34;,
+    &#34;message&#34;: &#34;Tool reference &#39;unknown_tool&#39; has no corresponding tool definition&#34;
+  }
+}
+```
+
+### Tool result errors (200 status)
+
+Errors during tool execution return a 200 response with error information in the body:
+
+```json JSON
+{
+  &#34;type&#34;: &#34;tool_result&#34;,
+  &#34;tool_use_id&#34;: &#34;srvtoolu_01ABC123&#34;,
+  &#34;content&#34;: {
+    &#34;type&#34;: &#34;tool_search_tool_result_error&#34;,
+    &#34;error_code&#34;: &#34;invalid_pattern&#34;
+  }
+}
+```
+
+**Error codes:**
+
+- `too_many_requests`: Rate limit exceeded for tool search operations
+- `invalid_pattern`: Malformed regex pattern
+- `pattern_too_long`: Pattern exceeds 200 character limit
+- `unavailable`: Tool search service temporarily unavailable
+
+### Common mistakes
+
+&lt;section title=&#34;400 Error: All tools are deferred&#34;&gt;
+
+**Cause**: You set `defer_loading: true` on ALL tools including the search tool
+
+**Fix**: Remove `defer_loading` from the tool search tool:
+
+```json
+{
+  &#34;type&#34;: &#34;tool_search_tool_regex_20251119&#34;, // No defer_loading here
+  &#34;name&#34;: &#34;tool_search_tool_regex&#34;
+}
+```
+
+&lt;/section&gt;
+
+&lt;section title=&#34;400 Error: Missing tool definition&#34;&gt;
+
+**Cause**: A `tool_reference` points to a tool not in your `tools` array
+
+**Fix**: Ensure every tool that could be discovered has a complete definition:
+
+```json
+{
+  &#34;name&#34;: &#34;my_tool&#34;,
+  &#34;description&#34;: &#34;Full description here&#34;,
+  &#34;input_schema&#34;: {
+    /* complete schema */
+  },
+  &#34;defer_loading&#34;: true
+}
+```
+
+&lt;/section&gt;
+
+&lt;section title=&#34;Claude doesn&#39;t find expected tools&#34;&gt;
+
+**Cause**: Tool names or descriptions don&#39;t match the regex pattern
+
+**Debugging steps:**
+
+1. Check tool name and descriptionâ€”Claude searches BOTH fields
+2. Test your pattern: `import re; re.search(r&#34;your_pattern&#34;, &#34;tool_name&#34;)`
+3. Remember searches are case-sensitive by default (use `(?i)` for case-insensitive)
+4. Claude uses broad patterns like `&#34;.*weather.*&#34;` not exact matches
+
+**Tip**: Add common keywords to tool descriptions to improve discoverability
+
+&lt;/section&gt;
+
+## Prompt caching
+
+Tool search works with [prompt caching](/docs/en/build-with-claude/prompt-caching). Add `cache_control` breakpoints to optimize multi-turn conversations:
+
+&lt;CodeGroup&gt;
+```python Python
+import anthropic
+
+client = anthropic.Anthropic()
+
+# First request with tool search
+messages = [
+    {
+        &#34;role&#34;: &#34;user&#34;,
+        &#34;content&#34;: &#34;What&#39;s the weather in Seattle?&#34;
+    }
+]
+
+response1 = client.beta.messages.create(
+    model=&#34;claude-sonnet-4-5-20250929&#34;,
+    betas=[&#34;advanced-tool-use-2025-11-20&#34;],
+    max_tokens=2048,
+    messages=messages,
+    tools=[
+        {
+            &#34;type&#34;: &#34;tool_search_tool_regex_20251119&#34;,
+            &#34;name&#34;: &#34;tool_search_tool_regex&#34;
+        },
+        {
+            &#34;name&#34;: &#34;get_weather&#34;,
+            &#34;description&#34;: &#34;Get weather for a location&#34;,
+            &#34;input_schema&#34;: {
+                &#34;type&#34;: &#34;object&#34;,
+                &#34;properties&#34;: {
+                    &#34;location&#34;: {&#34;type&#34;: &#34;string&#34;}
+                },
+                &#34;required&#34;: [&#34;location&#34;]
+            },
+            &#34;defer_loading&#34;: True
+        }
+    ]
+)
+
+# Add Claude&#39;s response to conversation
+messages.append({
+    &#34;role&#34;: &#34;assistant&#34;,
+    &#34;content&#34;: response1.content
+})
+
+# Second request with cache breakpoint
+messages.append({
+    &#34;role&#34;: &#34;user&#34;,
+    &#34;content&#34;: &#34;What about New York?&#34;,
+    &#34;cache_control&#34;: {&#34;type&#34;: &#34;ephemeral&#34;}
+})
+
+response2 = client.beta.messages.create(
+    model=&#34;claude-sonnet-4-5-20250929&#34;,
+    betas=[&#34;advanced-tool-use-2025-11-20&#34;],
+    max_tokens=2048,
+    messages=messages,
+    tools=[
+        {
+            &#34;type&#34;: &#34;tool_search_tool_regex_20251119&#34;,
+            &#34;name&#34;: &#34;tool_search_tool_regex&#34;
+        },
+        {
+            &#34;name&#34;: &#34;get_weather&#34;,
+            &#34;description&#34;: &#34;Get weather for a location&#34;,
+            &#34;input_schema&#34;: {
+                &#34;type&#34;: &#34;object&#34;,
+                &#34;properties&#34;: {
+                    &#34;location&#34;: {&#34;type&#34;: &#34;string&#34;}
+                },
+                &#34;required&#34;: [&#34;location&#34;]
+            },
+            &#34;defer_loading&#34;: True
+        }
+    ]
+)
+
+print(f&#34;Cache read tokens: {response2.usage.get(&#39;cache_read_input_tokens&#39;, 0)}&#34;)
+```
+&lt;/CodeGroup&gt;
+
+The system automatically expands tool_reference blocks throughout the entire conversation history, so Claude can reuse discovered tools in subsequent turns without re-searching.
+
+## Streaming
+
+With streaming enabled, you&#39;ll receive tool search events as part of the stream:
+
+```javascript
+event: content_block_start
+data: {&#34;type&#34;: &#34;content_block_start&#34;, &#34;index&#34;: 1, &#34;content_block&#34;: {&#34;type&#34;: &#34;server_tool_use&#34;, &#34;id&#34;: &#34;srvtoolu_xyz789&#34;, &#34;name&#34;: &#34;tool_search_tool_regex&#34;}}
+
+// Search query streamed
+event: content_block_delta
+data: {&#34;type&#34;: &#34;content_block_delta&#34;, &#34;index&#34;: 1, &#34;delta&#34;: {&#34;type&#34;: &#34;input_json_delta&#34;, &#34;partial_json&#34;: &#34;{\&#34;query\&#34;:\&#34;weather\&#34;}&#34;}}
+
+// Pause while search executes
+
+// Search results streamed
+event: content_block_start
+data: {&#34;type&#34;: &#34;content_block_start&#34;, &#34;index&#34;: 2, &#34;content_block&#34;: {&#34;type&#34;: &#34;tool_search_tool_result&#34;, &#34;tool_use_id&#34;: &#34;srvtoolu_xyz789&#34;, &#34;content&#34;: {&#34;type&#34;: &#34;tool_search_tool_search_result&#34;, &#34;tool_references&#34;: [{&#34;type&#34;: &#34;tool_reference&#34;, &#34;tool_name&#34;: &#34;get_weather&#34;}]}}}
+
+// Claude continues with discovered tools
+```
+
+## Batch requests
+
+You can include the tool search tool in the [Messages Batches API](/docs/en/build-with-claude/batch-processing). Tool search operations through the Messages Batches API are priced the same as those in regular Messages API requests.
+
+## Limits and best practices
+
+### Limits
+
+- **Maximum tools**: 10,000 tools in your catalog
+- **Search results**: Returns 3-5 most relevant tools per search
+- **Pattern length**: Maximum 200 characters for regex patterns
+- **Model support**: Sonnet 4.0+, Opus 4.0+ only (no Haiku)
+
+### When to use tool search
+
+**Good use cases:**
+
+- 10+ tools available in your system
+- Tool definitions consuming &gt;10K tokens
+- Experiencing tool selection accuracy issues with large tool sets
+- Building MCP-powered systems with multiple servers (200+ tools)
+- Tool library growing over time
+
+**When traditional tool calling might be better:**
+
+- Less than 10 tools total
+- All tools are frequently used in every request
+- Very small tool definitions (\&lt;100 tokens total)
+
+### Optimization tips
+
+- Keep 3-5 most frequently used tools as non-deferred
+- Write clear, descriptive tool names and descriptions
+- Use semantic keywords in descriptions that match how users describe tasks
+- Add a system prompt section describing available tool categories: &#34;You can search for tools to interact with Slack, GitHub, and Jira&#34;
+- Monitor which tools Claude discovers to refine descriptions
+
+## Usage
+
+Tool search tool usage is tracked in the response usage object:
+
+```json JSON
+{
+  &#34;usage&#34;: {
+    &#34;input_tokens&#34;: 1024,
+    &#34;output_tokens&#34;: 256,
+    &#34;server_tool_use&#34;: {
+      &#34;tool_search_requests&#34;: 2
+    }
+  }
+}
+```</code></pre>
    </div>
</body>
</html>